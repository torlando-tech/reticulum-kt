---
phase: 14-service-notification-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rns-android/src/main/kotlin/network/reticulum/android/ServiceConnectionState.kt
  - rns-android/src/main/kotlin/network/reticulum/android/NotificationContentBuilder.kt
  - rns-android/src/main/kotlin/network/reticulum/android/NotificationHelper.kt
autonomous: true

must_haves:
  truths:
    - "Notification displays one of five connection states: Connected, Partial, Connecting, Disconnected, Paused"
    - "Notification shows interface type breakdown like '2 TCP, 1 UDP'"
    - "Notification shows session uptime duration like 'Connected for 2h 34m'"
    - "Expanded notification shows per-interface status lines"
  artifacts:
    - path: "rns-android/src/main/kotlin/network/reticulum/android/ServiceConnectionState.kt"
      provides: "Connection state enum and computation logic"
      contains: "enum class ServiceConnectionState"
    - path: "rns-android/src/main/kotlin/network/reticulum/android/NotificationContentBuilder.kt"
      provides: "Builds Notification objects from connection state and interface data"
      contains: "class NotificationContentBuilder"
    - path: "rns-android/src/main/kotlin/network/reticulum/android/NotificationHelper.kt"
      provides: "Updated with rich notification building using BigTextStyle"
  key_links:
    - from: "NotificationContentBuilder"
      to: "ServiceConnectionState"
      via: "state computation from interface list"
      pattern: "computeState.*interfaces"
    - from: "NotificationContentBuilder"
      to: "NotificationCompat.Builder"
      via: "builds Android notification with BigTextStyle"
      pattern: "BigTextStyle|NotificationCompat"
---

<objective>
Create the connection state model and notification content builder for the persistent foreground service notification.

Purpose: Define the five connection states (Connected/Partial/Connecting/Disconnected/Paused), build the logic to compute state from interface data, and create the notification content builder that renders rich notifications with color-coded status, uptime, interface breakdown, and BigTextStyle expanded view. This establishes the data model and rendering layer that Plans 02 and 03 will wire into.

Output: ServiceConnectionState enum, NotificationContentBuilder class, enhanced NotificationHelper
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-service-notification-ux/14-CONTEXT.md
@rns-android/src/main/kotlin/network/reticulum/android/NotificationHelper.kt
@rns-android/src/main/kotlin/network/reticulum/android/NotificationChannels.kt
@rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ServiceConnectionState and state computation</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/ServiceConnectionState.kt</files>
  <action>
Create `ServiceConnectionState.kt` in the `network.reticulum.android` package with:

1. **Enum `ServiceConnectionState`** with five values:
   - `CONNECTED` - All configured interfaces are online
   - `PARTIAL` - Some but not all interfaces are online
   - `CONNECTING` - Service started but no interfaces online yet
   - `DISCONNECTED` - Service running but all interfaces are offline/detached
   - `PAUSED` - User explicitly paused via notification quick action

2. **Data class `InterfaceSnapshot`** representing a point-in-time interface status:
   - `name: String` - Interface name (e.g., "TCP to testnet")
   - `typeName: String` - Type category for grouping (e.g., "TCP", "UDP", "Auto")
   - `isOnline: Boolean`
   - `detail: String` - Additional detail for expanded view (e.g., "10.0.0.1:4242")

3. **Data class `ConnectionSnapshot`** containing:
   - `state: ServiceConnectionState`
   - `interfaces: List<InterfaceSnapshot>`
   - `sessionStartTime: Long` - System.currentTimeMillis() when service started
   - `enableTransport: Boolean` - Whether transport routing is enabled
   - `isPaused: Boolean` - Whether user paused

4. **Companion/top-level function `computeConnectionState`** that takes:
   - `interfaces: List<InterfaceSnapshot>` - Current interface snapshots
   - `isPaused: Boolean` - Whether paused by user
   - Returns `ServiceConnectionState`
   - Logic:
     - If `isPaused` -> `PAUSED`
     - If `interfaces.isEmpty()` -> `CONNECTING` (no interfaces registered yet)
     - If all online -> `CONNECTED`
     - If some online -> `PARTIAL`
     - If none online -> `DISCONNECTED`

5. **Function `formatInterfaceBreakdown`** that takes `List<InterfaceSnapshot>`:
   - Groups online interfaces by `typeName`
   - Returns string like "2 TCP, 1 UDP" or "1 TCP" or "No interfaces"
   - Only counts online interfaces

6. **Function `formatUptime`** that takes `sessionStartTime: Long`:
   - Computes elapsed time from sessionStartTime to now
   - Returns human-readable format: "2h 34m", "45m", "< 1m"
   - If elapsed < 60s: "< 1m"
   - If elapsed < 1h: "{m}m" (e.g., "45m")
   - If elapsed >= 1h: "{h}h {m}m" (e.g., "2h 34m")
  </action>
  <verify>Build compiles: `cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin 2>&1 | tail -5`</verify>
  <done>ServiceConnectionState enum exists with 5 states. computeConnectionState correctly classifies interface states. formatInterfaceBreakdown produces "2 TCP, 1 UDP" style output. formatUptime produces human-readable durations.</done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationContentBuilder and enhance NotificationHelper</name>
  <files>
    rns-android/src/main/kotlin/network/reticulum/android/NotificationContentBuilder.kt
    rns-android/src/main/kotlin/network/reticulum/android/NotificationHelper.kt
  </files>
  <action>
**Create `NotificationContentBuilder.kt`** in the `network.reticulum.android` package:

1. **Class `NotificationContentBuilder(context: Context)`** that builds rich notifications:

2. **Method `buildNotification(snapshot: ConnectionSnapshot, contentIntent: PendingIntent?, actions: List<NotificationCompat.Action> = emptyList()): Notification`**:
   - Title: "Reticulum {mode}" where mode is "Transport" or "Client" based on `snapshot.enableTransport`
   - Content text (collapsed view): "{State label} - {interface breakdown}" e.g., "Connected - 2 TCP, 1 UDP"
     - For PAUSED: "Paused"
     - For CONNECTING: "Connecting..."
     - For DISCONNECTED: "Disconnected"
     - For CONNECTED: "Connected - {breakdown}"
     - For PARTIAL: "Partial - {breakdown} online"
   - Use `NotificationCompat.BigTextStyle` for expanded view:
     - Line 1: status + breakdown (same as collapsed)
     - Line 2: uptime ("Connected for 2h 34m") — only if CONNECTED or PARTIAL
     - Lines 3+: per-interface status lines, one per interface:
       - Format: "{typeName} {name} -- {Online|Offline}"
       - e.g., "TCP testnet -- Online", "UDP mesh -- Offline"
   - Color-coded status using `setColor()` on the notification builder:
     - CONNECTED: green (0xFF4CAF50.toInt())
     - PARTIAL: orange (0xFFFF9800.toInt())
     - CONNECTING: yellow-orange (0xFFFFC107.toInt())
     - DISCONNECTED: red (0xFFF44336.toInt())
     - PAUSED: gray (0xFF9E9E9E.toInt())
   - Use `NotificationChannels.SERVICE_CHANNEL_ID`
   - Set `setSmallIcon(R.drawable.ic_reticulum)`
   - Set `setOngoing(true)`, `setCategory(CATEGORY_SERVICE)`, `setPriority(PRIORITY_LOW)`
   - Set `setForegroundServiceBehavior(FOREGROUND_SERVICE_IMMEDIATE)`
   - Set `setSilent(true)` to ensure no sound on update
   - Set `setContentIntent(contentIntent)` if provided
   - Add each action from the `actions` list
   - Set `setShowWhen(false)` — we show uptime manually, not system timestamp

3. **Constants** in companion object:
   - `NOTIFICATION_ID = 1001` (matches existing)

**Update `NotificationHelper.kt`**:
   - Add a new overload `createServiceNotification(snapshot: ConnectionSnapshot, contentIntent: PendingIntent? = null, actions: List<NotificationCompat.Action> = emptyList()): Notification` that delegates to `NotificationContentBuilder`.
   - Keep existing methods for backward compatibility (existing callers still work).
   - Add `updateNotification(notificationId: Int, snapshot: ConnectionSnapshot, contentIntent: PendingIntent? = null, actions: List<NotificationCompat.Action> = emptyList())` overload.
  </action>
  <verify>Build compiles: `cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin 2>&1 | tail -5`</verify>
  <done>NotificationContentBuilder produces rich notifications with BigTextStyle, color-coded status, interface breakdown, and uptime. NotificationHelper has new overloads accepting ConnectionSnapshot. Existing NotificationHelper methods still work.</done>
</task>

</tasks>

<verification>
1. `JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin` succeeds
2. ServiceConnectionState.kt exists with 5 enum values
3. NotificationContentBuilder.kt produces Notification objects
4. NotificationHelper has both old and new overloads
5. No existing code is broken (backward compatible)
</verification>

<success_criteria>
- Five connection states defined and computable from interface data
- Interface breakdown formatted as "2 TCP, 1 UDP" style
- Uptime formatted as human-readable duration
- Rich notification with BigTextStyle expanded view
- Color-coded status per connection state
- Backward-compatible NotificationHelper changes
- rns-android module compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/14-service-notification-ux/14-01-SUMMARY.md`
</output>
