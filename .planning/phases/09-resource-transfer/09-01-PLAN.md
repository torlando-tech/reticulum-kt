---
phase: 09-resource-transfer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceDeliveryTest.kt
autonomous: true

must_haves:
  truths:
    - "Message of 320+ bytes content uses RESOURCE representation, not PACKET"
    - "Large message from Kotlin arrives at Python with content intact"
    - "Large message from Python arrives at Kotlin with content intact"
    - "Message state reaches DELIVERED after Resource transfer"
  artifacts:
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceDeliveryTest.kt"
      provides: "Live Resource transfer tests over TCP between K<->P"
      exports: ["ResourceDeliveryTest"]
  key_links:
    - from: "ResourceDeliveryTest"
      to: "DirectDeliveryTestBase"
      via: "inheritance"
      pattern: "extends DirectDeliveryTestBase"
---

<objective>
Verify large LXMF messages (>319 bytes content) transfer correctly as Resources bidirectionally between Kotlin and Python.

Purpose: Proves Resource transfer interop works at the LXMF layer by testing threshold boundary and bidirectional delivery.
Output: ResourceDeliveryTest with 4-6 passing tests covering threshold detection and K<->P Resource delivery.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-resource-transfer/09-CONTEXT.md
@.planning/phases/09-resource-transfer/09-RESEARCH.md

Key references:
- lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt (test pattern to follow)
- lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/DirectDeliveryTestBase.kt (base class with TCP infrastructure)
- lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMFConstants.kt (LINK_PACKET_MAX_CONTENT = 319)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResourceDeliveryTest with threshold boundary tests</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceDeliveryTest.kt</files>
  <action>
Create ResourceDeliveryTest extending DirectDeliveryTestBase with:

1. Test: `message at 319 bytes content uses PACKET representation`
   - Create message with exactly 319 bytes content ("X".repeat(319))
   - Pack the message
   - Assert representation == MessageRepresentation.PACKET

2. Test: `message at 320 bytes content uses RESOURCE representation`
   - Create message with 320 bytes content ("X".repeat(320))
   - Pack the message
   - Assert representation == MessageRepresentation.RESOURCE

3. Helper method to create test message:
   ```kotlin
   private fun createTestMessage(contentSize: Int, title: String = "Resource Test"): LXMessage {
       val content = "X".repeat(contentSize)
       val pythonDest = createPythonDestination()!!
       return LXMessage.create(
           destination = pythonDest,
           source = kotlinDestination,
           content = content,
           title = title,
           desiredMethod = DeliveryMethod.DIRECT
       )
   }
   ```

Pattern after LiveDeliveryTest:
- Use @Test and @Timeout(60, unit = TimeUnit.SECONDS)
- Use runBlocking for coroutine tests
- Print diagnostic info for debugging

IMPORTANT: The threshold is LINK_PACKET_MAX_CONTENT = 319 bytes of CONTENT, not packed size.
The determination in LXMessage.determineDeliveryMethod() uses `packed!!.size - LXMFConstants.LXMF_OVERHEAD`
which gives the content size for comparison against LINK_PACKET_MAX_CONTENT.
  </action>
  <verify>
Run: `./gradlew :lxmf-core:test --tests "*.ResourceDeliveryTest.*threshold*" --info`
Both threshold tests should pass showing correct PACKET/RESOURCE selection.
  </verify>
  <done>
Threshold boundary tests pass: 319-byte content -> PACKET, 320-byte content -> RESOURCE.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bidirectional large message delivery tests</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceDeliveryTest.kt</files>
  <action>
Add to ResourceDeliveryTest:

1. Test: `Kotlin can send large message to Python via RESOURCE transfer`
   - Create message with 500 bytes content (well over threshold)
   - Send via kotlinRouter.handleOutbound()
   - Wait for Python to receive (use existing getPythonMessages() pattern)
   - Verify Python received message with correct content and title
   - Verify message state reaches DELIVERED

   Key assertion pattern:
   ```kotlin
   val received = withTimeoutOrNull(30.seconds) {  // Longer timeout for Resource
       var messages = getPythonMessages()
       while (messages.isEmpty()) {
           delay(200)  // Slightly longer poll for Resource transfer
           messages = getPythonMessages()
       }
       messages
   }
   received shouldNotBe null
   received!!.size shouldBe 1
   received[0].content shouldBe expectedContent
   ```

2. Test: `Python can send large message to Kotlin via RESOURCE transfer`
   - Register delivery callback for incoming messages
   - Announce Kotlin destination
   - Have Python send large message via lxmf_send_direct bridge command
   - Wait for callback with received message
   - Verify content preserved

3. Test: `bidirectional large message delivery works`
   - Combines K->P and P->K in single test
   - Verifies both directions with Resource transfer

Test content sizing:
- Use 500 bytes for "comfortably over threshold" tests
- Use 2048 bytes for "multi-part Resource" test (optional if time permits)

IMPORTANT: Resource transfers may take longer than packet delivery. Use 30-60 second timeouts.
  </action>
  <verify>
Run: `./gradlew :lxmf-core:test --tests "*.ResourceDeliveryTest" --info`
All tests pass (threshold + delivery tests).
  </verify>
  <done>
Large message delivery tests pass: K->P, P->K, and bidirectional all reach DELIVERED with content intact.
  </done>
</task>

</tasks>

<verification>
```bash
# Run all Resource delivery tests
./gradlew :lxmf-core:test --tests "*.ResourceDeliveryTest" --info

# Expected: 5-6 tests pass
# - threshold at 319 -> PACKET
# - threshold at 320 -> RESOURCE
# - K->P large message delivered
# - P->K large message delivered
# - bidirectional large message works
```
</verification>

<success_criteria>
1. All ResourceDeliveryTest tests pass
2. Threshold boundary correctly detected (319=PACKET, 320=RESOURCE)
3. Large messages (500+ bytes) transfer bidirectionally via Resource
4. Message state reaches DELIVERED (not just SENT or SENDING)
5. Content preserved exactly through Resource transfer
</success_criteria>

<output>
After completion, create `.planning/phases/09-resource-transfer/09-01-SUMMARY.md`
</output>
