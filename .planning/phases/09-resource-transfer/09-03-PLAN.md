---
phase: 09-resource-transfer
plan: 03
type: execute
wave: 2
depends_on: ["01", "02"]
files_modified:
  - rns-core/src/main/kotlin/network/reticulum/resource/Resource.kt
  - rns-core/src/main/kotlin/network/reticulum/link/Link.kt
  - test-scripts/debug_resource_flow.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Resource advertisement sent by Kotlin is received and parsed by Python"
    - "Resource request sent by Python is received and parsed by Kotlin"
    - "Resource parts sent by Kotlin are received and assembled by Python"
    - "Resource proof sent by Python is received and validated by Kotlin"
    - "Large LXMF message (500 bytes) reaches DELIVERED state within 60 seconds"
  artifacts:
    - path: "test-scripts/debug_resource_flow.py"
      provides: "Diagnostic tool for Resource protocol debugging"
    - path: "rns-core/src/main/kotlin/network/reticulum/resource/Resource.kt"
      provides: "Fixed Resource protocol implementation"
      min_lines: 1300
  key_links:
    - from: "Resource.kt:advertise()"
      to: "Python Resource.accept()"
      via: "RESOURCE_ADV packet over Link"
      pattern: "PacketContext.RESOURCE_ADV"
    - from: "Python request_next()"
      to: "Resource.kt:handleRequest()"
      via: "RESOURCE_REQ packet"
      pattern: "PacketContext.RESOURCE_REQ"
---

<objective>
Fix Resource protocol transfer between Kotlin and Python LXMF

Purpose: Gaps identified show Resource transfers timeout/fail - this plan diagnoses and fixes the root cause.
Output: Working Resource protocol transfer that reaches DELIVERED state for large LXMF messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-resource-transfer/09-VERIFICATION.md
@.planning/phases/09-resource-transfer/09-RESEARCH.md

# Reference implementations
@~/repos/Reticulum/RNS/Resource.py (Python reference - lines 1-400 for protocol flow)
@~/repos/Reticulum/RNS/Link.py (Python Link - resource handling)

# Kotlin implementations to debug/fix
@rns-core/src/main/kotlin/network/reticulum/resource/Resource.kt
@rns-core/src/main/kotlin/network/reticulum/link/Link.kt

# Existing tests (for verification after fix)
@lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceDeliveryTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create diagnostic Python script to trace Resource protocol flow</name>
  <files>test-scripts/debug_resource_flow.py</files>
  <action>
Create a diagnostic Python script that:

1. Sets up a Python LXMF receiver with detailed Resource protocol logging:
   - Log when ResourceAdvertisement is received (parse and print fields)
   - Log when Resource.accept() is called
   - Log when request_next() sends RESOURCE_REQ (print requested hashes)
   - Log when parts are received (part index, hash match)
   - Log when assembly begins
   - Log when proof is sent

2. Enable RNS.LOG_DEBUG and RNS.LOG_EXTREME logging for Resource-related messages

3. Print packet context bytes for all packets received on the link:
   - RESOURCE_ADV (0x02) - advertisement
   - RESOURCE_REQ (0x03) - request
   - RESOURCE_HMU (0x04) - hashmap update
   - RESOURCE_PRF (0x0D) - proof

4. Run with: `python test-scripts/debug_resource_flow.py`

The script should accept a large message from Kotlin and trace every step of the Resource protocol.

Key diagnostic questions to answer:
- Does Python receive the RESOURCE_ADV packet at all?
- Does Python parse the advertisement correctly?
- Does Python send RESOURCE_REQ back?
- Does Kotlin receive the RESOURCE_REQ?
- Does Kotlin send parts in response?
- Do parts arrive at Python?
  </action>
  <verify>
- Script runs without errors: `python test-scripts/debug_resource_flow.py`
- Script outputs "Waiting for connections..."
- Script shows packet context logging when Kotlin connects
  </verify>
  <done>
Diagnostic script created that traces Resource protocol flow with detailed logging for each packet type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Debug and fix Resource protocol issue</name>
  <files>
    rns-core/src/main/kotlin/network/reticulum/resource/Resource.kt
    rns-core/src/main/kotlin/network/reticulum/link/Link.kt
  </files>
  <action>
Using the diagnostic script from Task 1, run a live test to identify where the Resource protocol fails:

1. Start the Python diagnostic receiver
2. Run a Kotlin test that sends a 500-byte LXMF message
3. Analyze the diagnostic output to identify the failure point

Common issues to check (based on Python reference code analysis):

**Advertisement Phase (Kotlin sends, Python receives):**
- Verify RESOURCE_ADV packet format matches Python expectations
- Check that advertisement is encrypted with link key before sending
- Verify all ResourceAdvertisement fields are packed correctly (hash, randomHash, flags, etc.)

**Request Phase (Python sends, Kotlin receives):**
- Check if Kotlin's processResourceReq() is being called
- Verify Kotlin correctly decrypts and parses the request
- Check that Kotlin extracts requested part hashes correctly

**Data Transfer Phase (Kotlin sends parts):**
- Verify Kotlin sends parts with correct map hash format
- Check that parts are NOT encrypted separately (Resource uses link-encrypted stream)
- Verify sendPart() actually transmits data

**Proof Phase (Python sends, Kotlin receives):**
- Check if Kotlin receives RESOURCE_PRF packet
- Verify proof format matches: [resource_hash (16 bytes)][proof (32 bytes)]
- Verify validateProof() calculation matches Python

Fix the identified issues in Resource.kt or Link.kt. Document each fix with a comment explaining what was wrong.

IMPORTANT: After each potential fix, run a quick test to verify the change has effect. Don't make multiple speculative changes - isolate each issue.
  </action>
  <verify>
Run the ResourceDeliveryTest with strict assertions:
```bash
cd ~/repos/public/reticulum-kt
./gradlew :lxmf-core:test --tests "ResourceDeliveryTest.Kotlin can send large message to Python via RESOURCE transfer" -i 2>&1 | tail -100
```

Look for:
- Message reaches Python (getPythonMessages returns non-empty)
- Final state is DELIVERED (not OUTBOUND/SENDING)
- Content matches (500 bytes of 'X')
  </verify>
  <done>
Resource protocol bug identified and fixed. Large message (500 bytes) transfers successfully K->P with DELIVERED state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Tighten test assertions and verify bidirectional transfer</name>
  <files>
    lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceDeliveryTest.kt
  </files>
  <action>
Now that Resource protocol works, update tests to have strict assertions:

1. In `Kotlin can send large message to Python via RESOURCE transfer`:
   - Change assertion from accepting OUTBOUND to requiring DELIVERED
   - Remove comments about "known timing issues"
   - Assert that Python received the message (not just "may have received")
   - Keep reasonable timeout (60 seconds for Resource transfer)

2. In `Python can send large message to Kotlin via RESOURCE transfer`:
   - Assert that receivedMessages is non-empty (not just print info)
   - Verify content matches (500 bytes of 'Y')
   - Remove comments about "known limitation"

3. In `bidirectional large message delivery works`:
   - Require both K->P and P->K to succeed (not "pending is acceptable")
   - Assert content integrity in both directions

4. Update test class comments to remove references to "known timing issues" and "Phase 8.1 findings about Resource timeout"

IMPORTANT: Only make these changes AFTER Task 2 confirms Resource transfer works. If Task 2 did not fully fix the issue, leave assertions flexible but add TODO comments for what remains to be fixed.
  </action>
  <verify>
Run all ResourceDeliveryTest tests:
```bash
cd ~/repos/public/reticulum-kt
./gradlew :lxmf-core:test --tests "ResourceDeliveryTest" -i 2>&1 | tail -100
```

All 5 tests should pass with strict assertions:
- `message at 319 bytes content uses PACKET representation`
- `message at 320 bytes content uses RESOURCE representation`
- `Kotlin can send large message to Python via RESOURCE transfer`
- `Python can send large message to Kotlin via RESOURCE transfer`
- `bidirectional large message delivery works`
  </verify>
  <done>
All ResourceDeliveryTest tests pass with strict assertions requiring DELIVERED state and content verification.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Run full test suite:
```bash
./gradlew :lxmf-core:test --tests "ResourceDeliveryTest" --tests "ResourceCompressionTest" --tests "ResourceProgressTest"
```

2. Verify Resource protocol flow in diagnostic output:
- RESOURCE_ADV received by Python
- RESOURCE_REQ sent by Python, received by Kotlin
- Parts sent by Kotlin, received by Python
- Proof sent by Python, validated by Kotlin

3. Check no regressions in other delivery tests:
```bash
./gradlew :lxmf-core:test --tests "LiveDeliveryTest"
```
</verification>

<success_criteria>
- Resource protocol fully functional K<->P
- Large messages (500+ bytes) reach DELIVERED state
- All ResourceDeliveryTest tests pass with strict assertions
- No regressions in existing delivery tests
</success_criteria>

<output>
After completion, create `.planning/phases/09-resource-transfer/09-03-SUMMARY.md`
</output>
