---
phase: 09-resource-transfer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceCompressionTest.kt
autonomous: true

must_haves:
  truths:
    - "BZ2 compressed data from Kotlin decompresses correctly in Python"
    - "BZ2 compressed data from Python decompresses correctly in Kotlin"
    - "Progress callbacks fire during Resource transfer"
    - "Multi-KB message transfers with content intact"
  artifacts:
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceCompressionTest.kt"
      provides: "BZ2 compression interop and progress callback tests"
      exports: ["ResourceCompressionTest"]
  key_links:
    - from: "ResourceCompressionTest"
      to: "InteropTestBase"
      via: "inheritance for Python bridge"
      pattern: "extends InteropTestBase"
---

<objective>
Verify BZ2 compression interoperability between Kotlin and Python, and test progress callback behavior during Resource transfers.

Purpose: Ensures compression layer works bidirectionally and progress tracking functions correctly.
Output: ResourceCompressionTest with 4-5 passing tests covering BZ2 interop and progress callbacks.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-resource-transfer/09-CONTEXT.md
@.planning/phases/09-resource-transfer/09-RESEARCH.md

Key references:
- rns-core/src/main/kotlin/network/reticulum/resource/Resource.kt (BZ2 compression implementation)
- rns-test/src/test/kotlin/network/reticulum/interop/resource/ResourceInteropTest.kt (existing pattern)
- python-bridge/bridge_server.py (may need to add bz2 commands)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BZ2 compression commands to Python bridge</name>
  <files>python-bridge/bridge_server.py</files>
  <action>
Add two new bridge commands for BZ2 compression testing:

1. `bz2_compress` - Compress data using Python's bz2 module
   ```python
   def bz2_compress(params):
       import bz2
       data_hex = params.get("data")
       data = bytes.fromhex(data_hex)
       compressed = bz2.compress(data)
       return {"compressed": compressed.hex()}
   ```

2. `bz2_decompress` - Decompress BZ2 data using Python's bz2 module
   ```python
   def bz2_decompress(params):
       import bz2
       compressed_hex = params.get("compressed")
       compressed = bytes.fromhex(compressed_hex)
       decompressed = bz2.decompress(compressed)
       return {"decompressed": decompressed.hex()}
   ```

Add these to the command dispatch dict.

IMPORTANT: Use hex encoding for binary data to avoid JSON encoding issues.
  </action>
  <verify>
Run bridge server and test commands manually, or verify in subsequent test task.
  </verify>
  <done>
Python bridge has bz2_compress and bz2_decompress commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ResourceCompressionTest with BZ2 interop tests</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceCompressionTest.kt</files>
  <action>
Create ResourceCompressionTest extending InteropTestBase (not DirectDeliveryTestBase - we're testing compression layer, not full delivery):

1. Test: `Kotlin BZ2 compressed data decompresses in Python`
   - Create test data: repeating pattern that compresses well (e.g., "Hello World ".repeat(100))
   - Compress with Apache Commons BZ2 (use Resource.compress helper or create local method)
   - Send to Python via bz2_decompress bridge command
   - Verify decompressed data matches original

   Compression helper:
   ```kotlin
   private fun compressBz2(data: ByteArray): ByteArray {
       val output = ByteArrayOutputStream()
       BZip2CompressorOutputStream(output).use { bz2 ->
           bz2.write(data)
       }
       return output.toByteArray()
   }

   private fun decompressBz2(compressed: ByteArray): ByteArray {
       return BZip2CompressorInputStream(ByteArrayInputStream(compressed)).use { bz2 ->
           bz2.readBytes()
       }
   }
   ```

2. Test: `Python BZ2 compressed data decompresses in Kotlin`
   - Create test data
   - Send to Python via bz2_compress bridge command
   - Decompress result with Apache Commons BZ2
   - Verify decompressed data matches original

3. Test: `round-trip BZ2 compression preserves data`
   - Compress in Kotlin -> Decompress in Python -> Compress in Python -> Decompress in Kotlin
   - Verify data integrity throughout

4. Test: `incompressible data handled correctly`
   - Create random/already-compressed data
   - Verify both sides handle it without error (may not compress smaller)

Imports needed:
```kotlin
import org.apache.commons.compress.compressors.bzip2.BZip2CompressorInputStream
import org.apache.commons.compress.compressors.bzip2.BZip2CompressorOutputStream
```
  </action>
  <verify>
Run: `./gradlew :lxmf-core:test --tests "*.ResourceCompressionTest.*BZ2*" --info`
All BZ2 interop tests pass.
  </verify>
  <done>
BZ2 compression tests pass: Kotlin->Python decompression works, Python->Kotlin decompression works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add progress callback verification test</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ResourceCompressionTest.kt</files>
  <action>
Add a test that extends DirectDeliveryTestBase specifically for progress callback testing:

Create separate test class or nested class that extends DirectDeliveryTestBase:

```kotlin
class ResourceProgressTest : DirectDeliveryTestBase() {

    @Test
    @Timeout(90, unit = TimeUnit.SECONDS)
    fun `progress callbacks fire during large message Resource transfer`() = runBlocking {
        // Track progress updates
        val progressUpdates = CopyOnWriteArrayList<Double>()

        // Create large message (5KB - triggers multi-part Resource)
        val largeContent = "X".repeat(5000)
        val pythonDest = createPythonDestination()!!

        val message = LXMessage.create(
            destination = pythonDest,
            source = kotlinDestination,
            content = largeContent,
            title = "Progress Test",
            desiredMethod = DeliveryMethod.DIRECT
        )

        // Register delivery callback to track progress
        message.deliveryCallback = { msg ->
            println("[Progress] Final state: ${msg.state}, progress: ${msg.progress}")
        }

        // Track progress via message.progress field
        // LXMRouter.sendDirectMessage sets progressCallback on Resource

        println("[Test] Sending large message...")
        kotlinRouter.handleOutbound(message)

        // Poll for progress updates and completion
        val delivered = withTimeoutOrNull(60.seconds) {
            while (message.state != MessageState.DELIVERED) {
                if (message.progress > 0) {
                    if (progressUpdates.isEmpty() || progressUpdates.last() != message.progress) {
                        progressUpdates.add(message.progress)
                        println("[Progress] ${message.progress}")
                    }
                }
                delay(50)
            }
            true
        }

        delivered shouldBe true

        // Verify Python received it
        val received = getPythonMessages()
        received.size shouldBe 1
        received[0].content shouldBe largeContent

        // Verify progress was tracked (may have few or many updates depending on timing)
        println("[Test] Progress updates captured: ${progressUpdates.size}")
        println("[Test] Progress values: $progressUpdates")

        // At minimum, progress should reach 1.0 (or close) by end
        // Note: progress may jump directly to 1.0 for fast transfers
    }
}
```

Key points:
- Use 5KB message to ensure multi-part Resource transfer
- Progress updates are set via message.progress in LXMRouter
- Don't require specific number of updates (timing-dependent)
- Verify message reaches DELIVERED with content intact
  </action>
  <verify>
Run: `./gradlew :lxmf-core:test --tests "*.ResourceProgressTest" --info`
Progress test passes with progress tracking output.
  </verify>
  <done>
Progress callback test passes: progress tracked during Resource transfer, message delivered with content intact.
  </done>
</task>

</tasks>

<verification>
```bash
# Run all compression and progress tests
./gradlew :lxmf-core:test --tests "*.ResourceCompressionTest" --tests "*.ResourceProgressTest" --info

# Expected: 5-6 tests pass
# - Kotlin BZ2 -> Python decompress
# - Python BZ2 -> Kotlin decompress
# - Round-trip compression
# - Incompressible data handling
# - Progress callbacks during transfer
```
</verification>

<success_criteria>
1. All ResourceCompressionTest tests pass
2. BZ2 compressed data from Kotlin decompresses in Python correctly
3. BZ2 compressed data from Python decompresses in Kotlin correctly
4. Progress updates captured during large message transfer
5. Large messages (5KB+) transfer with content intact
</success_criteria>

<output>
After completion, create `.planning/phases/09-resource-transfer/09-02-SUMMARY.md`
</output>
