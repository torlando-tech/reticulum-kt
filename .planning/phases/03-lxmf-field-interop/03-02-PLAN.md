---
phase: 03-lxmf-field-interop
plan: 02
type: execute
wave: 1
depends_on: ["03-01"]
files_modified:
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ImageFieldInteropTest.kt
autonomous: true

must_haves:
  truths:
    - "Kotlin message with WebP image unpacks in Python with correct extension and content"
    - "Python message with image unpacks in Kotlin with correct extension and content"
    - "Image binary data matches byte-for-byte via SHA-256 comparison"
  artifacts:
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ImageFieldInteropTest.kt"
      provides: "FIELD_IMAGE round-trip verification"
      min_lines: 80
  key_links:
    - from: "ImageFieldInteropTest"
      to: "PythonBridge"
      via: "lxmf_unpack_with_fields command"
      pattern: "lxmf_unpack_with_fields"
---

<objective>
Implement FIELD_IMAGE round-trip verification between Kotlin and Python.

Purpose: Prove that image attachments in LXMF messages survive Kotlin-Python round-trips with byte-level accuracy, including extension encoding and binary image data preservation.

Output: ImageFieldInteropTest with bidirectional image verification tests using WebP format.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lxmf-field-interop/03-RESEARCH.md

# Key reference files
@lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LXMFInteropTestBase.kt
@lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/AttachmentFieldInteropTest.kt
@lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMFConstants.kt

# From research: minimal WebP image bytes
# MINIMAL_WEBP is 34 bytes for 1x1 pixel valid WebP
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ImageFieldInteropTest</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/ImageFieldInteropTest.kt</files>
  <action>
Create ImageFieldInteropTest extending LXMFInteropTestBase with these test cases:

1. `webp image field round-trips correctly` - Create message with minimal WebP image (34 bytes), verify extension is "webp" and bytes match in Python

2. `larger image content preserved` - Create message with 10KB random bytes as image content, verify SHA-256 checksum matches

3. `extension encoding as UTF-8 bytes` - Verify extension is stored as bytes not string, test with "png" and "jpeg" extensions too

4. `image field with empty content` - Test edge case of image field with empty byte array (discover Python behavior)

Key implementation details:
- FIELD_IMAGE structure: `listOf(extension.toByteArray(Charsets.UTF_8), imageBytes)`
- Field key is `LXMFConstants.FIELD_IMAGE` (0x06)
- Use `lxmf_unpack_with_fields` from Plan 01 for hex-encoded field verification
- Reuse field parsing helpers from AttachmentFieldInteropTest

Minimal WebP constant (from research):
```kotlin
companion object {
    // Minimal 1x1 pixel WebP image (34 bytes)
    val MINIMAL_WEBP = byteArrayOf(
        0x52, 0x49, 0x46, 0x46,  // "RIFF"
        0x1a, 0x00, 0x00, 0x00,  // File size - 8
        0x57, 0x45, 0x42, 0x50,  // "WEBP"
        0x56, 0x50, 0x38, 0x4c,  // "VP8L"
        0x0d, 0x00, 0x00, 0x00,  // Chunk size
        0x2f, 0x00, 0x00, 0x00,  // Signature
        0x00, 0x00, 0x00, 0x00,  // 1x1 image data
        0x00, 0x00, 0x00, 0x00,
        0x00
    ).also { require(it.size == 33) { "Expected 33 bytes, got ${it.size}" } }
    // Note: Research says 34 bytes but verify actual size
}
```

Test fixture structure:
```kotlin
fun createImageMessage(extension: String, imageBytes: ByteArray): LXMessage {
    val imageField = listOf(
        extension.toByteArray(Charsets.UTF_8),
        imageBytes
    )
    return createTestMessage(
        content = "Message with image",
        fields = mutableMapOf(
            LXMFConstants.FIELD_IMAGE to imageField
        )
    )
}
```

Use SHA-256 for comparing larger image data:
```kotlin
fun ByteArray.sha256Hex(): String {
    val digest = MessageDigest.getInstance("SHA-256")
    return digest.digest(this).toHex()
}
```
  </action>
  <verify>
```bash
JAVA_HOME=~/android-studio/jbr ./gradlew :lxmf-core:test --tests "ImageFieldInteropTest" --info
```
All 4 tests should pass.
  </verify>
  <done>ImageFieldInteropTest passes all tests proving FIELD_IMAGE survives Kotlin-Python round-trip with WebP format.</done>
</task>

</tasks>

<verification>
1. ImageFieldInteropTest runs all 4 tests
2. All tests pass with timing logs showing bridge communication
3. WebP extension encoded correctly as UTF-8 bytes
4. Image binary content matches via SHA-256 comparison
5. Git status shows only expected file modifications
</verification>

<success_criteria>
- FIELD_IMAGE with WebP data survives round-trip
- Extension bytes (UTF-8 encoded) match between implementations
- Binary image content matches byte-for-byte
- Edge cases (empty content) documented with Python behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-lxmf-field-interop/03-02-SUMMARY.md`
</output>
