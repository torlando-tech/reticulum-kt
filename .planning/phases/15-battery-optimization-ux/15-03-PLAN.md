---
phase: 15-battery-optimization-ux
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/viewmodel/ReticulumViewModel.kt
  - rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/ui/screens/MonitorScreen.kt
autonomous: false

must_haves:
  truths:
    - "Battery card on Monitor screen shows drain rate (%/hr)"
    - "Battery card shows a line chart of battery level over time"
    - "Inline warning appears on battery card when optimization kills detected"
    - "Warning has 'Fix' button that launches exemption bottom sheet"
    - "Bottom sheet explains impacts and has one-tap exemption button"
    - "Warning is dismissable and remembers dismissal"
    - "Exemption prompt appears on first service start"
  artifacts:
    - path: "rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/ui/screens/MonitorScreen.kt"
      provides: "Enhanced battery card with drain rate, chart, warning, and exemption bottom sheet"
      min_lines: 200
    - path: "rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/viewmodel/ReticulumViewModel.kt"
      provides: "Battery stats and event tracker state flows for UI consumption"
  key_links:
    - from: "MonitorScreen"
      to: "ReticulumViewModel"
      via: "collectAsState on batteryStats and serviceEvents flows"
      pattern: "batteryStats.*collectAsState"
    - from: "ReticulumViewModel"
      to: "ReticulumService"
      via: "getBatteryStatsTracker() and getEventTracker()"
      pattern: "getBatteryStatsTracker|getEventTracker"
    - from: "MonitorScreen exemption button"
      to: "BatteryExemptionHelper.buildExemptionIntent()"
      via: "context.startActivity(intent)"
      pattern: "startActivity.*exemption"
---

<objective>
Build the user-facing battery optimization UX: enhanced Monitor battery card with drain rate, history chart, optimization impact warning, and exemption request bottom sheet.

Purpose: Users understand battery impact, see concrete evidence of optimization problems, and can request exemption with one tap. This completes all Phase 15 success criteria for user-visible battery optimization UX.

Output: Enhanced MonitorScreen with battery stats, chart, and exemption flow. Updated ViewModel with battery data flows.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-battery-optimization-ux/15-CONTEXT.md
@.planning/phases/15-battery-optimization-ux/15-01-SUMMARY.md
@.planning/phases/15-battery-optimization-ux/15-02-SUMMARY.md
@rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/ui/screens/MonitorScreen.kt
@rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/viewmodel/ReticulumViewModel.kt
@rns-android/src/main/kotlin/network/reticulum/android/BatteryStatsTracker.kt
@rns-android/src/main/kotlin/network/reticulum/android/ServiceEventTracker.kt
@rns-android/src/main/kotlin/network/reticulum/android/BatteryExemptionHelper.kt
@rns-android/src/main/kotlin/network/reticulum/android/BatteryOptimizationChecker.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire battery stats and events into ViewModel</name>
  <files>rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/viewmodel/ReticulumViewModel.kt</files>
  <action>
Add battery stats and service event state flows to ReticulumViewModel for UI consumption.

Changes to ReticulumViewModel:

1. Add new state flows:
   - `private val _batteryStats = MutableStateFlow(BatteryStats default)` -- import BatteryStats from rns-android
   - `val batteryStats: StateFlow<BatteryStats>` -- exposed to UI
   - `private val _serviceEvents = MutableStateFlow(ServiceEvents default)` -- import ServiceEvents from rns-android
   - `val serviceEvents: StateFlow<ServiceEvents>` -- exposed to UI
   - `private val _showExemptionSheet = MutableStateFlow(false)` -- controls bottom sheet visibility
   - `val showExemptionSheet: StateFlow<Boolean>` -- exposed to UI

2. In startService(), after wiring service callbacks and before the status refresh loop:
   - Access service.getBatteryStatsTracker() and collect its stats StateFlow into _batteryStats
   - Access service.getEventTracker() and collect its events StateFlow into _serviceEvents
   - Check BatteryExemptionHelper.shouldPrompt(context) -- if true, set _showExemptionSheet.value = true

3. In the periodic status refresh (statusRefreshJob), alongside updateMonitorState():
   - Read fresh batteryStats from service tracker and update _batteryStats
   - Read fresh serviceEvents from service tracker and update _serviceEvents

4. Add action methods for UI:
   - `fun dismissExemptionSheet()` -- sets _showExemptionSheet to false, calls BatteryExemptionHelper(context).markPromptDismissed(context)
   - `fun showExemptionSheet()` -- sets _showExemptionSheet to true (for "Fix" button in warning)
   - `fun dismissOptimizationWarning()` -- calls service.getEventTracker()?.dismissWarning()
   - `fun requestBatteryExemption(): Intent` -- returns BatteryExemptionHelper(context).buildExemptionIntent() for the UI to launch via startActivity

5. Ensure BatteryStatsTracker is properly wired in ReticulumService (if not done in Plan 02, do it here):
   - In ReticulumService.onCreate(), initialize and start BatteryStatsTracker
   - In ReticulumService.onDestroy(), stop BatteryStatsTracker
   - Add getter method
  </action>
  <verify>
Build compiles: JAVA_HOME=~/android-studio/jbr ./gradlew :rns-sample-app:compileDebugKotlin
  </verify>
  <done>
ViewModel exposes batteryStats, serviceEvents, and showExemptionSheet StateFlows. Action methods handle exemption sheet dismiss, warning dismiss, and exemption intent building.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Monitor screen battery card with stats, chart, warning, and exemption sheet</name>
  <files>rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/ui/screens/MonitorScreen.kt</files>
  <action>
Enhance the Battery card on the MonitorScreen and add the exemption bottom sheet.

Changes to MonitorScreen:

1. **Enhanced Battery Card** -- Replace the existing simple Battery card with an enhanced version:
   - Collect `viewModel.batteryStats` and `viewModel.serviceEvents` as state
   - Row 1: "Level" -> "${batteryStats.currentLevel}%" (existing)
   - Row 2: "Status" -> charging/discharging (existing)
   - Row 3: "Drain Rate" -> "${String.format("%.1f", batteryStats.drainRatePerHour)}%/hr" or "Charging" if charging
   - Row 4: "Session Drain" -> "${String.format("%.1f", batteryStats.sessionDrainRate)}%/hr" (since service start)
   - Row 5: "Power Save" -> On/Off (existing)

2. **Battery History Chart** -- Add a Canvas-based line chart below the stats rows:
   - Height: 120.dp
   - X-axis: time (last 4 hours or session duration, whichever is shorter)
   - Y-axis: battery level 0-100%
   - Draw with MaterialTheme.colorScheme.primary color, 2.dp stroke
   - Fill area below line with primary.copy(alpha = 0.1f)
   - Light gray horizontal gridlines at 25%, 50%, 75%
   - If fewer than 2 samples, show "Collecting data..." text instead of chart
   - Use Compose Canvas directly -- no external chart library needed

3. **Optimization Impact Warning** -- Conditionally show an inline warning card between the Battery and Doze cards:
   - Only visible when `serviceEvents.hasActiveWarning` is true AND `!monitorState.batteryExempt`
   - Orange/amber container color (MaterialTheme.colorScheme.errorContainer or custom)
   - Warning icon (Icons.Filled.Warning)
   - Text: "Service killed ${serviceEvents.killCountToday} time(s) today. Battery optimization may be restricting background processes."
   - Two buttons in a Row:
     - "Fix" (filled button) -> calls viewModel.showExemptionSheet()
     - "Dismiss" (text button) -> calls viewModel.dismissOptimizationWarning()

4. **Battery Exemption Bottom Sheet** -- Add a ModalBottomSheet:
   - Controlled by `viewModel.showExemptionSheet.collectAsState()`
   - Title: "Battery Optimization"
   - Body text: "Battery optimization restricts background processes. Exempt this app for persistent mesh connectivity."
   - Bullet points explaining impacts:
     - "Dropped connections during Doze mode"
     - "Missed messages when screen is off"
     - "Delayed routing for mesh traffic"
   - Action button: "Exempt from Battery Optimization" (filled, primary)
     - onClick: get exemption intent from viewModel.requestBatteryExemption(), launch with context.startActivity(), dismiss sheet
   - "Not Now" text button -> calls viewModel.dismissExemptionSheet()
   - Uses ExperimentalMaterial3Api ModalBottomSheet

5. **Also prompt on first service start** -- The ViewModel handles this (sets showExemptionSheet in startService if shouldPrompt is true). The MonitorScreen just needs to observe and display.

Make sure to add necessary imports: ModalBottomSheet, rememberModalBottomSheetState, Canvas, Path, drawPath, Icons.Filled.Warning, Button, TextButton, etc.
  </action>
  <verify>
Build compiles: JAVA_HOME=~/android-studio/jbr ./gradlew :rns-sample-app:compileDebugKotlin
  </verify>
  <done>
Monitor battery card shows drain rate, session stats, line chart of level history, inline optimization warning with Fix/Dismiss, and exemption bottom sheet with one-tap system intent.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete battery optimization UX: enhanced Monitor battery card with drain rate (%/hr), Canvas line chart of battery history, inline optimization impact warning with kill count, dismissable warning with memory, and battery exemption bottom sheet with system intent launch.
  </what-built>
  <how-to-verify>
1. Build and deploy: JAVA_HOME=~/android-studio/jbr ./gradlew :rns-sample-app:installDebug
2. Open app, start service, navigate to Monitor tab
3. Verify Battery card shows:
   - Level percentage
   - Drain rate (may show 0.0%/hr initially -- needs time to collect samples)
   - Session drain rate
   - Chart area (should show "Collecting data..." initially, then a line after a few minutes)
4. Check exemption bottom sheet appears on first service start (if app is not already exempt)
5. Dismiss sheet, verify it does not reappear on next service start
6. If service has been killed by system, verify warning appears with kill count
7. Verify "Fix" button in warning opens the exemption bottom sheet
8. Verify "Dismiss" button hides the warning
9. Verify "Exempt from Battery Optimization" button launches system dialog
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
JAVA_HOME=~/android-studio/jbr ./gradlew :rns-sample-app:compileDebugKotlin
Full build passes. Battery card enhanced with stats, chart, warning, and exemption flow.
</verification>

<success_criteria>
- Monitor Battery card shows drain rate (%/hr) computed from samples
- Canvas line chart renders battery level history (or "Collecting data..." placeholder)
- Inline warning shows kill count when optimization events detected
- Warning has "Fix" and "Dismiss" buttons that work correctly
- Bottom sheet explains impacts and launches system exemption intent
- Exemption prompt appears once on first service start, never again after dismissal
- All code compiles and deploys to device
</success_criteria>

<output>
After completion, create `.planning/phases/15-battery-optimization-ux/15-03-SUMMARY.md`
</output>
