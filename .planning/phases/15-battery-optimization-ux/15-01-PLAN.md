---
phase: 15-battery-optimization-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rns-android/src/main/kotlin/network/reticulum/android/BatteryStatsTracker.kt
  - rns-android/src/main/kotlin/network/reticulum/android/BatteryExemptionHelper.kt
autonomous: true

must_haves:
  truths:
    - "Battery drain rate (%/hr) is computed from periodic samples"
    - "Battery level history is available for chart rendering (last 24h)"
    - "Exemption status is detectable and system intent can be launched"
    - "First-prompt-only logic prevents repeated exemption prompts"
  artifacts:
    - path: "rns-android/src/main/kotlin/network/reticulum/android/BatteryStatsTracker.kt"
      provides: "Battery level sampling, drain rate computation, and history storage"
      min_lines: 80
    - path: "rns-android/src/main/kotlin/network/reticulum/android/BatteryExemptionHelper.kt"
      provides: "Battery exemption intent builder and first-prompt tracking"
      min_lines: 40
  key_links:
    - from: "BatteryStatsTracker"
      to: "BatteryMonitor"
      via: "reads batteryLevel periodically"
      pattern: "batteryMonitor\\.batteryLevel"
    - from: "BatteryExemptionHelper"
      to: "BatteryOptimizationChecker"
      via: "checks isExempt status"
      pattern: "isIgnoringBatteryOptimizations"
---

<objective>
Create battery statistics tracking infrastructure and exemption request helper.

Purpose: Provide the data layer for battery drain rate computation, level history for chart rendering, and a helper for launching the system battery exemption intent with first-prompt-only semantics.

Output: Two new classes in rns-android module -- BatteryStatsTracker for stats and BatteryExemptionHelper for exemption flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-battery-optimization-ux/15-CONTEXT.md
@rns-android/src/main/kotlin/network/reticulum/android/BatteryMonitor.kt
@rns-android/src/main/kotlin/network/reticulum/android/BatteryOptimizationChecker.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BatteryStatsTracker</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/BatteryStatsTracker.kt</files>
  <action>
Create BatteryStatsTracker class that periodically samples battery level and computes drain statistics.

Requirements:
- Constructor takes Context (for BatteryManager access)
- Samples battery level every 60 seconds via a coroutine loop (takes CoroutineScope parameter)
- Stores samples as List of (timestamp: Long, level: Int) pairs in a data class `BatterySample`
- Keeps up to 1440 samples in memory (24 hours at 1-minute intervals)
- Exposes via StateFlow a `BatteryStats` data class containing:
  - `currentLevel: Int` (latest sample)
  - `drainRatePerHour: Float` (computed from last 60 minutes of samples, or session if shorter)
  - `sessionDrainRate: Float` (drain rate since tracker started)
  - `samples: List<BatterySample>` (full history for chart)
  - `sessionStartTime: Long` (when tracking began)
  - `isCharging: Boolean` (latest charging state)
- Drain rate calculation: (startLevel - endLevel) / hours elapsed. If charging, drain rate is 0.0 or negative (show as "Charging")
- start(scope: CoroutineScope) method to begin sampling
- stop() method to cancel sampling
- Persist samples to SharedPreferences as JSON on stop() and restore on start() so stats survive service restarts. Use a simple key like "battery_samples_json". Trim samples older than 24 hours on restore.
- Use android.os.BatteryManager for level reads (same pattern as BatteryMonitor)
  </action>
  <verify>
Build compiles: JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin
  </verify>
  <done>
BatteryStatsTracker compiles and provides drain rate, session stats, and 24h sample history via StateFlow. Samples persist across restarts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BatteryExemptionHelper</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/BatteryExemptionHelper.kt</files>
  <action>
Create BatteryExemptionHelper class that encapsulates the battery optimization exemption request flow.

Requirements:
- Constructor takes Context
- `isExempt(): Boolean` - checks PowerManager.isIgnoringBatteryOptimizations(packageName)
- `buildExemptionIntent(): Intent` - builds ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS intent with package URI ("package:$packageName"). This is the system dialog that directly asks the user.
- `shouldPrompt(context: Context): Boolean` - returns true if:
  (a) app is NOT already exempt, AND
  (b) user has NOT previously dismissed the prompt (check SharedPreferences key "battery_exemption_dismissed", default false)
- `markPromptDismissed(context: Context)` - sets SharedPreferences "battery_exemption_dismissed" to true. After this, shouldPrompt() always returns false regardless of exemption status.
- `resetPromptDismissed(context: Context)` - for testing/settings: clears the dismissed flag so user can be prompted again
- Use the same SharedPreferences file as BatteryStatsTracker: context.getSharedPreferences("reticulum_battery", Context.MODE_PRIVATE)
- Include companion object constants for intent action and SharedPreferences keys
- Include kdoc explaining the flow: prompt on first service start, user dismisses once = never again, user can find it in Monitor screen

The system intent (ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS) is the one-tap approach from CONTEXT.md. The bottom sheet UI that wraps this intent will be built in Plan 03.
  </action>
  <verify>
Build compiles: JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin
  </verify>
  <done>
BatteryExemptionHelper compiles and provides exemption check, intent builder, and first-prompt-only semantics via SharedPreferences.
  </done>
</task>

</tasks>

<verification>
JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin
Both new files compile without errors and follow existing codebase patterns.
</verification>

<success_criteria>
- BatteryStatsTracker samples battery every 60s, computes drain rate from samples, exposes stats via StateFlow
- BatteryStatsTracker persists/restores samples across service restarts (SharedPreferences)
- BatteryExemptionHelper provides isExempt(), buildExemptionIntent(), shouldPrompt(), markPromptDismissed()
- Both classes compile cleanly as part of rns-android module
</success_criteria>

<output>
After completion, create `.planning/phases/15-battery-optimization-ux/15-01-SUMMARY.md`
</output>
