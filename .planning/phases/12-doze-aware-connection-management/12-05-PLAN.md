---
phase: 12-doze-aware-connection-management
plan: 05
type: execute
wave: 3
depends_on: [12-03, 12-04]
files_modified:
  - rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt
autonomous: true

must_haves:
  truths:
    - "InterfaceManager observes NetworkStateObserver for network changes"
    - "Network changes trigger onNetworkChanged() on all TCP interfaces"
    - "Backoff resets when network type changes (WiFi to cellular, offline to online)"
    - "Logging shows when network change triggers interface notification"
  artifacts:
    - path: "rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt"
      provides: "Network change handling for TCP interfaces"
      contains: "onNetworkChanged"
  key_links:
    - from: "InterfaceManager"
      to: "NetworkStateObserver"
      via: "StateFlow collection in scope"
      pattern: "networkObserver\\.state\\.collect"
    - from: "InterfaceManager network collector"
      to: "TCPClientInterface.onNetworkChanged()"
      via: "method call on each interface"
      pattern: "onNetworkChanged\\(\\)"
---

<objective>
Wire network change notifications from InterfaceManager to TCP interfaces.

Purpose: Complete the network transition handling by notifying TCP interfaces when network changes. Per CONTEXT.md, "Network changes reset the backoff counter (fresh start on new network)". This enables quick reconnection when WiFi/cellular transitions occur.

Output: Modified InterfaceManager that observes network state and notifies interfaces.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-doze-aware-connection-management/12-CONTEXT.md
@.planning/phases/12-doze-aware-connection-management/12-RESEARCH.md
@rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt
@rns-android/src/main/kotlin/network/reticulum/android/NetworkStateObserver.kt
@rns-interfaces/src/main/kotlin/network/reticulum/interfaces/tcp/TCPClientInterface.kt (from Plan 04)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NetworkStateObserver parameter to InterfaceManager</name>
  <files>rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt</files>
  <action>
Modify InterfaceManager to accept NetworkStateObserver:

1. Check current InterfaceManager constructor signature and add optional parameter:
   ```kotlin
   class InterfaceManager(
       private val scope: CoroutineScope,
       private val networkObserver: NetworkStateObserver? = null  // Optional for backward compat
   ) {
   ```

2. Store reference to previous network state for detecting changes:
   ```kotlin
   private var previousNetworkType: NetworkType? = null
   ```

3. Add a method to start network observation:
   ```kotlin
   /**
    * Start observing network state changes.
    * Must be called after interfaces are registered.
    */
   fun startNetworkObservation() {
       val observer = networkObserver ?: return

       scope.launch {
           observer.state.collect { state ->
               val currentType = state.type
               val previousType = previousNetworkType

               // Detect actual network type changes (not just repeated events)
               if (previousType != null && currentType != previousType) {
                   Log.i(TAG, "Network type changed: $previousType -> $currentType")
                   notifyNetworkChange()
               }

               previousNetworkType = currentType
           }
       }
   }
   ```

Add necessary imports for Log, NetworkType, etc.
  </action>
  <verify>`./gradlew :rns-sample-app:compileDebugKotlin` succeeds</verify>
  <done>InterfaceManager accepts optional NetworkStateObserver and tracks network type changes</done>
</task>

<task type="auto">
  <name>Task 2: Implement notifyNetworkChange for TCP interfaces</name>
  <files>rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt</files>
  <action>
Add method to notify all TCP interfaces of network changes:

```kotlin
/**
 * Notify all TCP client interfaces that the network has changed.
 * This resets their reconnection backoff for quick reconnection.
 */
private fun notifyNetworkChange() {
    interfaces.forEach { iface ->
        when (iface) {
            is TCPClientInterface -> {
                Log.d(TAG, "Notifying ${iface.name} of network change")
                iface.onNetworkChanged()
            }
            // UDP interfaces are connectionless, no notification needed
            // Other interface types can be added as needed
        }
    }
}
```

Note: The `interfaces` list should already exist in InterfaceManager. Check the current implementation and adapt as needed.

If interfaces are stored differently (e.g., as InterfaceRef or different collection), adapt the iteration accordingly.
  </action>
  <verify>`./gradlew :rns-sample-app:compileDebugKotlin` succeeds</verify>
  <done>notifyNetworkChange() iterates TCP interfaces and calls onNetworkChanged()</done>
</task>

<task type="auto">
  <name>Task 3: Wire NetworkStateObserver from ReticulumService to InterfaceManager</name>
  <files>rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt</files>
  <action>
Ensure InterfaceManager can receive NetworkStateObserver from ReticulumService:

1. If InterfaceManager is created in sample app (not in ReticulumService), update the creation site to pass the observer:
   ```kotlin
   // In whatever creates InterfaceManager:
   val interfaceManager = InterfaceManager(
       scope = serviceScope,
       networkObserver = reticulumService.getNetworkObserver()
   )
   interfaceManager.startNetworkObservation()
   ```

2. If InterfaceManager is created elsewhere, document where the observer should be passed.

3. Add a TAG constant if not present:
   ```kotlin
   companion object {
       private const val TAG = "InterfaceManager"
   }
   ```

Note: The exact wiring location depends on where InterfaceManager is instantiated. Check the sample app structure and wire appropriately.
  </action>
  <verify>`./gradlew :rns-sample-app:compileDebugKotlin` succeeds</verify>
  <done>InterfaceManager wiring documented/implemented for network observer</done>
</task>

</tasks>

<verification>
1. `./gradlew :rns-sample-app:compileDebugKotlin` - InterfaceManager compiles
2. `./gradlew :rns-sample-app:testDebugUnitTest` - Existing tests pass
3. Grep for "onNetworkChanged" in InterfaceManager - Call present in notifyNetworkChange
4. Grep for "NetworkStateObserver" in InterfaceManager - Import and parameter present
5. Verify network type change detection logic: only notifies when type actually changes
</verification>

<success_criteria>
- InterfaceManager can observe NetworkStateObserver
- Network type changes (WiFi <-> Cellular, None <-> Connected) trigger notifications
- All registered TCPClientInterface instances receive onNetworkChanged() calls
- Backward compatible - observer is optional with null default
- Logging shows when network changes trigger interface notifications
</success_criteria>

<output>
After completion, create `.planning/phases/12-doze-aware-connection-management/12-05-SUMMARY.md`
</output>
