---
phase: 12-doze-aware-connection-management
plan: 03
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt
autonomous: true

must_haves:
  truths:
    - "ConnectionPolicyProvider is instantiated with observers in onCreate"
    - "Transport.customJobIntervalMs is updated when policy changes"
    - "Base interval 250ms is multiplied by throttle multiplier"
    - "Log messages indicate when throttling changes (reason visible)"
    - "Provider is stopped in onDestroy before other cleanup"
  artifacts:
    - path: "rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt"
      provides: "Wired ConnectionPolicyProvider with Transport throttling"
      contains: "Transport.customJobIntervalMs"
  key_links:
    - from: "ReticulumService"
      to: "ConnectionPolicyProvider"
      via: "provider.policy.collect"
      pattern: "policy\\.collect"
    - from: "ReticulumService policy collector"
      to: "Transport.customJobIntervalMs"
      via: "assignment in collect block"
      pattern: "customJobIntervalMs\\s*="
---

<objective>
Wire ConnectionPolicyProvider into ReticulumService to throttle Transport job intervals.

Purpose: Connect the connection policy flow from Plan 01 to the actual Transport job loop. When Doze mode is active or battery is low, the Transport loop will run slower (5x), reducing wake-ups and battery drain.

Output: Modified ReticulumService that dynamically adjusts Transport.customJobIntervalMs based on ConnectionPolicy.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-doze-aware-connection-management/12-CONTEXT.md
@.planning/phases/12-doze-aware-connection-management/12-RESEARCH.md
@rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt
@rns-android/src/main/kotlin/network/reticulum/android/ConnectionPolicy.kt (from Plan 01)
@rns-android/src/main/kotlin/network/reticulum/android/ConnectionPolicyProvider.kt (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ConnectionPolicyProvider to ReticulumService</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt</files>
  <action>
Modify ReticulumService to add ConnectionPolicyProvider:

1. Add new lateinit property after existing observers:
   ```kotlin
   private lateinit var policyProvider: ConnectionPolicyProvider
   ```

2. In onCreate(), after starting the three observers (dozeObserver, networkObserver, batteryChecker), add:
   ```kotlin
   // Create BatteryMonitor for policy provider
   val batteryMonitor = BatteryMonitor(this)
   batteryMonitor.start()

   // Create connection policy provider
   policyProvider = ConnectionPolicyProvider(
       dozeObserver = dozeObserver,
       networkObserver = networkObserver,
       batteryMonitor = batteryMonitor,
       scope = lifecycleScope
   )
   policyProvider.start()
   ```

3. Store batteryMonitor as a property so it can be stopped in onDestroy:
   ```kotlin
   private lateinit var batteryMonitor: BatteryMonitor
   ```

4. In onDestroy(), before stopping other observers, add:
   ```kotlin
   policyProvider.stop()
   batteryMonitor.stop()
   ```
  </action>
  <verify>`./gradlew :rns-android:compileDebugKotlin` succeeds</verify>
  <done>ConnectionPolicyProvider initialized in onCreate and stopped in onDestroy</done>
</task>

<task type="auto">
  <name>Task 2: Wire policy changes to Transport.customJobIntervalMs</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt</files>
  <action>
Add policy collection that updates Transport job interval:

1. In onCreate(), after starting policyProvider, replace the placeholder Doze collector (the existing one that just logs) with a policy collector:
   ```kotlin
   // Replace placeholder collectors with real policy-based throttling
   lifecycleScope.launch {
       policyProvider.policy.collect { policy ->
           // Base interval from Python: 250ms (Transport.JOB_INTERVAL)
           val baseIntervalMs = network.reticulum.transport.TransportConstants.JOB_INTERVAL
           val throttledIntervalMs = (baseIntervalMs * policy.throttleMultiplier).toLong()

           network.reticulum.transport.Transport.customJobIntervalMs = throttledIntervalMs

           Log.i(TAG, "Transport job interval: ${throttledIntervalMs}ms (${policy.reason})")

           if (!policy.networkAvailable) {
               Log.w(TAG, "Network unavailable - connections may pause")
           }
       }
   }
   ```

2. Remove or modify the existing placeholder collectors:
   - Keep the network state collector but update it to mention that policy handles throttling
   - Keep the battery optimization collector for Phase 15 (separate from throttling)

3. Ensure the policy collector starts AFTER policyProvider.start() is called
  </action>
  <verify>`./gradlew :rns-android:compileDebugKotlin` succeeds</verify>
  <done>Policy changes trigger Transport.customJobIntervalMs updates with logging</done>
</task>

<task type="auto">
  <name>Task 3: Add public getter for ConnectionPolicyProvider</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt</files>
  <action>
Add public getter for downstream access (Plan 04 will need this for interface reconnection):

```kotlin
/**
 * Get the connection policy provider.
 * Downstream phases use this to apply throttling to reconnection logic.
 */
fun getPolicyProvider(): ConnectionPolicyProvider = policyProvider
```

This follows the existing pattern of getDozeObserver(), getNetworkObserver(), getBatteryChecker().
  </action>
  <verify>`./gradlew :rns-android:compileDebugKotlin` succeeds</verify>
  <done>getPolicyProvider() method available for downstream interface wiring</done>
</task>

</tasks>

<verification>
1. `./gradlew :rns-android:compileDebugKotlin` - ReticulumService compiles
2. Inspect ReticulumService.kt - policyProvider instantiated after observers
3. Grep for "customJobIntervalMs" in ReticulumService - assignment in policy collector
4. Verify onDestroy order: policyProvider.stop() -> batteryMonitor.stop() -> other observers
5. `./gradlew :rns-android:testDebugUnitTest` - Existing tests still pass
</verification>

<success_criteria>
- ConnectionPolicyProvider properly wired in service lifecycle
- Transport.customJobIntervalMs dynamically updated on policy changes
- Logging shows throttle reason (Charging, Dozing, Low battery, Normal)
- BatteryMonitor lifecycle properly managed
- getPolicyProvider() available for Plan 04
</success_criteria>

<output>
After completion, create `.planning/phases/12-doze-aware-connection-management/12-03-SUMMARY.md`
</output>
