---
phase: 12-doze-aware-connection-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - rns-interfaces/src/main/kotlin/network/reticulum/interfaces/backoff/ExponentialBackoff.kt
  - rns-interfaces/src/test/kotlin/network/reticulum/interfaces/backoff/ExponentialBackoffTest.kt
autonomous: true

must_haves:
  truths:
    - "ExponentialBackoff starts at 1 second delay"
    - "Maximum backoff caps at 60 seconds"
    - "Multiplier is 2.0 (1s, 2s, 4s, 8s, 16s, 32s, 60s...)"
    - "Gives up after 10 consecutive failures (returns null)"
    - "reset() restores initial state for fresh network connections"
  artifacts:
    - path: "rns-interfaces/src/main/kotlin/network/reticulum/interfaces/backoff/ExponentialBackoff.kt"
      provides: "Stateful backoff calculator with reset capability"
      min_lines: 30
    - path: "rns-interfaces/src/test/kotlin/network/reticulum/interfaces/backoff/ExponentialBackoffTest.kt"
      provides: "Unit tests for backoff behavior"
      min_lines: 50
  key_links:
    - from: "ExponentialBackoff"
      to: "TCPClientInterface.reconnect()"
      via: "nextDelay() returns delay or null"
      pattern: "nextDelay\\(\\)"
---

<objective>
Create ExponentialBackoff utility for intelligent reconnection timing.

Purpose: Replace the fixed 5-second reconnect delay in TCPClientInterface with exponential backoff that starts at 1s, doubles each failure up to 60s max, and gives up after 10 attempts. This is the core reconnection strategy defined in CONTEXT.md.

Output: A reusable backoff utility in rns-interfaces module (not Android-specific) with comprehensive unit tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-doze-aware-connection-management/12-CONTEXT.md
@.planning/phases/12-doze-aware-connection-management/12-RESEARCH.md
@rns-interfaces/src/main/kotlin/network/reticulum/interfaces/tcp/TCPClientInterface.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExponentialBackoff class</name>
  <files>rns-interfaces/src/main/kotlin/network/reticulum/interfaces/backoff/ExponentialBackoff.kt</files>
  <action>
Create new package `network.reticulum.interfaces.backoff` and ExponentialBackoff.kt with:

```kotlin
package network.reticulum.interfaces.backoff

/**
 * Exponential backoff calculator for reconnection attempts.
 *
 * Starts at [initialDelayMs] (default 1 second), doubles each attempt
 * up to [maxDelayMs] (default 60 seconds), and gives up after
 * [maxAttempts] (default 10) consecutive failures.
 *
 * Call [reset] when connection succeeds or network changes to start fresh.
 *
 * Usage:
 * ```kotlin
 * val backoff = ExponentialBackoff()
 * while (!connected) {
 *     val delayMs = backoff.nextDelay() ?: break  // null = give up
 *     delay(delayMs)
 *     connected = tryConnect()
 * }
 * if (connected) backoff.reset()
 * ```
 */
class ExponentialBackoff(
    private val initialDelayMs: Long = 1000L,
    private val maxDelayMs: Long = 60_000L,
    private val multiplier: Double = 2.0,
    private val maxAttempts: Int = 10
) {
    private var currentDelay = initialDelayMs
    private var attempts = 0

    /**
     * Get the next delay in milliseconds.
     *
     * @return Delay before next attempt, or null if max attempts reached
     */
    fun nextDelay(): Long? {
        if (attempts >= maxAttempts) return null

        val delay = currentDelay
        currentDelay = minOf((currentDelay * multiplier).toLong(), maxDelayMs)
        attempts++

        return delay
    }

    /**
     * Reset the backoff state.
     *
     * Call this when:
     * - Connection succeeds (reward success)
     * - Network type changes (fresh start on new network)
     */
    fun reset() {
        currentDelay = initialDelayMs
        attempts = 0
    }

    /**
     * Current attempt number (0-based, incremented by nextDelay).
     */
    val attemptCount: Int
        get() = attempts

    /**
     * Whether max attempts have been reached.
     */
    val isExhausted: Boolean
        get() = attempts >= maxAttempts
}
```

Add KDoc explaining the backoff sequence and when to reset.
  </action>
  <verify>`./gradlew :rns-interfaces:compileKotlin` succeeds</verify>
  <done>ExponentialBackoff.kt exists in backoff package with documented API</done>
</task>

<task type="auto">
  <name>Task 2: Create ExponentialBackoff unit tests</name>
  <files>rns-interfaces/src/test/kotlin/network/reticulum/interfaces/backoff/ExponentialBackoffTest.kt</files>
  <action>
Create ExponentialBackoffTest.kt with JUnit 5 tests:

1. `test initial delay is 1 second` - First nextDelay() returns 1000L
2. `test delay doubles each attempt` - Sequence is 1000, 2000, 4000, 8000...
3. `test delay caps at max 60 seconds` - After enough calls, stays at 60000L
4. `test returns null after 10 attempts` - 10th call returns value, 11th returns null
5. `test reset restores initial state` - After reset(), nextDelay() returns 1000L again
6. `test attemptCount tracks correctly` - Starts at 0, increments with each nextDelay()
7. `test isExhausted returns true after max` - False until 10 attempts, then true
8. `test custom parameters work` - Different initial, max, multiplier, maxAttempts

Example test structure:
```kotlin
@Test
fun `delay sequence follows exponential pattern`() {
    val backoff = ExponentialBackoff()

    assertEquals(1000L, backoff.nextDelay())
    assertEquals(2000L, backoff.nextDelay())
    assertEquals(4000L, backoff.nextDelay())
    assertEquals(8000L, backoff.nextDelay())
    assertEquals(16000L, backoff.nextDelay())
    assertEquals(32000L, backoff.nextDelay())
    assertEquals(60000L, backoff.nextDelay())  // capped at max
    assertEquals(60000L, backoff.nextDelay())  // stays at max
}
```
  </action>
  <verify>`./gradlew :rns-interfaces:test --tests "*.ExponentialBackoffTest"` passes</verify>
  <done>8 unit tests validate backoff behavior including edge cases</done>
</task>

</tasks>

<verification>
1. `./gradlew :rns-interfaces:compileKotlin` - ExponentialBackoff compiles
2. `./gradlew :rns-interfaces:test --tests "*.ExponentialBackoffTest"` - All 8 tests pass
3. Inspect ExponentialBackoff.kt - Default values match CONTEXT.md (1s, 60s, 10 attempts)
4. Verify backoff package exists: `ls rns-interfaces/src/main/kotlin/network/reticulum/interfaces/backoff/`
</verification>

<success_criteria>
- ExponentialBackoff class is pure Kotlin (no Android dependencies)
- Default parameters match CONTEXT.md: 1s initial, 60s max, 10 attempts
- reset() method exists for network change handling
- 8 unit tests pass validating core behavior
- Class is reusable for TCP and UDP interfaces
</success_criteria>

<output>
After completion, create `.planning/phases/12-doze-aware-connection-management/12-02-SUMMARY.md`
</output>
