---
phase: 06-direct-delivery
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Delivery callbacks fire when messages are delivered"
    - "MessageState transitions correctly during delivery lifecycle"
    - "Messages with custom fields and attachments arrive intact over live Link"
  artifacts:
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt"
      provides: "Extended live delivery tests with callback and field verification"
      contains: "deliveryCallback"
  key_links:
    - from: "LiveDeliveryTest"
      to: "LXMessage.deliveryCallback"
      via: "callback registration and verification"
      pattern: "deliveryCallback"
    - from: "LiveDeliveryTest"
      to: "LXMessage.state"
      via: "state transition assertions"
      pattern: "MessageState"
---

<objective>
Close verification gaps for Phase 6 Direct Delivery by adding tests for delivery callbacks, MessageState transitions, and field preservation over live Links.

Purpose: The verification found that while basic Kotlin<->Python delivery now works (fixed in 4a5b292), the tests don't verify:
1. Delivery callbacks fire correctly
2. MessageState transitions through OUTBOUND -> SENT -> DELIVERED
3. Custom fields and attachments survive live Link delivery (only pack/unpack format was tested)

Output: Extended LiveDeliveryTest.kt with comprehensive callback, state, and field preservation tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt
@lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMessage.kt
@lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMRouter.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delivery callback and MessageState tests</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt</files>
  <action>
Add new tests to LiveDeliveryTest that verify:

1. **Kotlin -> Python with delivery callback**:
   - Register `message.deliveryCallback` before sending
   - Send via `kotlinRouter.handleOutbound()`
   - Verify callback fires when Python confirms receipt
   - Verify message.state == MessageState.DELIVERED or SENT

2. **MessageState lifecycle tracking**:
   - Create message (state should be NEW or null initially)
   - Call handleOutbound (state should transition to OUTBOUND)
   - After delivery attempt (state should transition to SENT)
   - After Python confirmation (state may transition to DELIVERED)
   - Track and assert these transitions

3. **Failed delivery callback test** (optional if time permits):
   - Send to non-existent destination
   - Verify state transitions to FAILED
   - Verify failedCallback fires

Use existing test patterns from LiveDeliveryTest. Reference LXMessage.kt for state/callback fields and LXMRouter.kt for how callbacks are invoked.
  </action>
  <verify>
Run: JAVA_HOME=~/android-studio/jbr ./gradlew :lxmf-core:test --tests "LiveDeliveryTest" --rerun-tasks 2>&1
All tests pass including new callback and state tests.
  </verify>
  <done>
- Test exists that registers deliveryCallback and verifies it fires on successful K->P delivery
- Test exists that tracks MessageState transitions during delivery
- All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add live field preservation tests</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt</files>
  <action>
Add tests that verify custom fields survive live Link delivery (not just pack/unpack):

1. **Custom fields over live Link**:
   - Create message with custom fields (e.g., FIELD_RENDERER = "renderer", FIELD_THREAD_ID = "thread123")
   - Send via live TCP connection to Python
   - Verify Python receives and reports correct field values via getPythonMessages() or enhanced bridge command

2. **If Python bridge returns fields**: Modify getPythonMessages() to include fields_hex from Python response, then verify in test.

3. **If Python bridge doesn't return fields**: Check existing bridge commands for field extraction, or add note that full field preservation over Link is validated by existing pack/unpack tests (Phase 3).

Reference Phase 3 tests (CustomFieldInteropTest) for field handling patterns.
Reference bridge_server.py for how to get field data from Python LXMF.
  </action>
  <verify>
Run: JAVA_HOME=~/android-studio/jbr ./gradlew :lxmf-core:test --tests "LiveDeliveryTest" --rerun-tasks 2>&1
All tests pass including field preservation test.
  </verify>
  <done>
- Test exists that sends message with custom fields over live Link
- Test verifies fields arrive correctly (or documents why pack/unpack validation is sufficient)
- All tests pass
  </done>
</task>

</tasks>

<verification>
After completing all tasks, run the full test suite:

```bash
JAVA_HOME=~/android-studio/jbr ./gradlew :lxmf-core:test --tests "*LiveDeliveryTest*" --rerun-tasks 2>&1
```

Expected: All tests pass, including new callback/state/field tests.

Also verify Phase 6 truths are now covered:
1. "Kotlin client can send LXMessage to Python client over Link" - existing tests
2. "Python client can send LXMessage to Kotlin client over Link" - existing tests
3. "Message content and fields preserved end-to-end" - new field tests
4. "Delivery receipts/confirmations work bidirectionally" - new callback tests
</verification>

<success_criteria>
1. LiveDeliveryTest includes test that verifies delivery callback fires
2. LiveDeliveryTest includes test that tracks MessageState transitions
3. LiveDeliveryTest includes test for field preservation over live Link (or documents validation approach)
4. All existing and new tests pass
5. Gap closure documented in commit message
</success_criteria>

<output>
After completion, create `.planning/phases/06-direct-delivery/06-03-SUMMARY.md`
</output>
