---
phase: 08.1-tcp-interface-interop
plan: 04
type: execute
wave: 1
depends_on: ["08.1-03"]
files_modified:
  - lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMRouter.kt
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTest.kt
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Propagated delivery messages reach SENT or DELIVERED state within timeout"
    - "PropagatedDeliveryTest uses strict assertions requiring message delivery confirmation"
    - "Link established callback for delivery path (forRetrieval=false) triggers processOutbound"
    - "Link established callback for retrieval path (forRetrieval=true) triggers requestMessageList"
  artifacts:
    - path: "lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMRouter.kt"
      provides: "Fixed establishPropagationLink callback for message submission"
      contains: "processOutbound"
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTest.kt"
      provides: "Strict assertions for propagated delivery"
      contains: "MessageState.SENT"
  key_links:
    - from: "establishPropagationLink(forRetrieval=false) callback"
      to: "processOutbound()"
      via: "Link established callback for delivery path"
      pattern: "forRetrieval.*processOutbound"
    - from: "establishPropagationLink(forRetrieval=true) callback"
      to: "requestMessageList()"
      via: "Link established callback for retrieval path"
      pattern: "forRetrieval.*requestMessageList"
---

<objective>
Fix LXMF propagation protocol link establishment to enable strict test assertions.

Purpose: Close the verification gap where PropagatedDeliveryTest uses flexible assertions instead of requiring DELIVERED/SENT state. The root cause is that `establishPropagationLink` callback doesn't re-trigger outbound message processing like Python's implementation does.

Output: LXMRouter with correct propagation link callback, PropagatedDeliveryTest with strict assertions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-tcp-interface-interop/08.1-VERIFICATION.md
@.planning/phases/08.1-tcp-interface-interop/08.1-03-SUMMARY.md

# Reference implementation
@~/repos/LXMF/LXMF/LXMRouter.py (lines 2700-2715)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix establishPropagationLink with parametric callback for delivery vs retrieval</name>
  <files>lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMRouter.kt</files>
  <action>
    The current `establishPropagationLink` function uses the same callback for BOTH code paths, but Python's implementation uses DIFFERENT callbacks:
    - **Delivery path (Python line 2709):** `established_callback=self.process_outbound`
    - **Retrieval path (Python line 512):** `established_callback=msg_request_established_callback` (calls requestMessageList, NOT processOutbound)

    **The parametric approach is REQUIRED to match Python's architecture:**

    1. Add a `forRetrieval` parameter to `establishPropagationLink`:
       ```kotlin
       private fun establishPropagationLink(node: PropagationNode, forRetrieval: Boolean = true)
       ```

    2. Modify the `establishedCallback` to branch based on purpose:
       ```kotlin
       establishedCallback = { establishedLink ->
           outboundPropagationLink = establishedLink
           propagationTransferState = PropagationTransferState.LINK_ESTABLISHED

           // Identify ourselves on the link
           identifyOnLink(establishedLink)

           if (forRetrieval) {
               // Retrieval path: request message list (existing behavior)
               requestMessageList(establishedLink)
           } else {
               // Delivery path: re-trigger outbound processing for pending messages
               processingScope?.launch {
                   processOutbound()
               }
           }
       }
       ```

    3. Update call site at line 836 (processPropagatedDelivery - DELIVERY path):
       ```kotlin
       establishPropagationLink(node, forRetrieval = false)
       ```

    4. Call site at line 1484 (requestMessagesFromPropagationNode - RETRIEVAL path) uses default `forRetrieval = true`, so no change needed.

    **Why NOT the simpler "always call processOutbound" approach:**
    Calling processOutbound() during message retrieval would:
    - Unnecessarily attempt to send outbound messages when user only wants to retrieve
    - Deviate from Python's architecture which separates these concerns
    - Potentially cause side effects during retrieval operations

    Note: processOutbound() is a suspend function, so it needs to be launched in a coroutine.
  </action>
  <verify>
    1. Build compiles: `./gradlew :lxmf-core:compileKotlin`
    2. Verify line 836 call passes `forRetrieval = false` (delivery path)
    3. Verify line 1484 call uses default `forRetrieval = true` (retrieval path)
    4. Check that processingScope is available in the callback context
  </verify>
  <done>
    establishPropagationLink uses parametric callback: forRetrieval=false triggers processOutbound() (delivery), forRetrieval=true triggers requestMessageList() (retrieval)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PropagatedDeliveryTest with strict assertions</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTest.kt</files>
  <action>
    With Task 1 fix in place, update the submission test to require strict assertions.

    **In `Kotlin can submit message to Python propagation node` test (around line 142-147):**

    Replace the flexible assertion:
    ```kotlin
    val validStates = listOf(MessageState.OUTBOUND, MessageState.SENDING, MessageState.SENT, MessageState.DELIVERED)
    validStates shouldContain message.state
    ```

    With strict assertion requiring delivery confirmation:
    ```kotlin
    // TCP transport layer verified working (Plans 01-02)
    // LXMF propagation link now triggers processOutbound on establishment (Plan 04)
    // Message should reach SENT (accepted by node) or DELIVERED (fully confirmed)
    val finalStates = listOf(MessageState.SENT, MessageState.DELIVERED)
    if (message.state !in finalStates) {
        println("[KT] ERROR: Expected SENT or DELIVERED but got ${message.state}")
        println("[KT] Message hash: ${message.hash?.toHex()}")
    }
    finalStates shouldContain message.state
    ```

    Also update the wait loop condition to match - it already waits for SENT or DELIVERED.

    **Update the logging comment (around line 150-153):**
    Remove or update the note about "LXMF propagation protocol issues beyond TCP layer" since we're fixing that issue.

    **Keep retrieval test assertions as-is** - retrieval is a different flow and may have separate issues. Focus on submission for this gap closure.
  </action>
  <verify>
    1. Run the test: `./gradlew :lxmf-core:test --tests "*PropagatedDeliveryTest*" --info`
    2. If test passes, assertions are now strict
    3. If test fails, check diagnostic output to understand what's happening
  </verify>
  <done>
    PropagatedDeliveryTest submission test uses strict assertions requiring SENT or DELIVERED state
  </done>
</task>

</tasks>

<verification>
1. Build compiles without errors
2. Verify BOTH code paths have correct callback behavior:
   - Delivery path (line 836): calls establishPropagationLink with forRetrieval=false, callback triggers processOutbound()
   - Retrieval path (line 1484): calls establishPropagationLink with forRetrieval=true (default), callback triggers requestMessageList()
3. PropagatedDeliveryTest `Kotlin can submit message to Python propagation node` passes with strict assertions
4. All other PropagatedDeliveryTest tests still pass (including retrieval tests - validates retrieval path not broken)
5. All LiveDeliveryTest tests still pass (no regression)
6. All TcpPythonInteropTest tests still pass (no regression)
</verification>

<success_criteria>
- establishPropagationLink uses forRetrieval parameter to differentiate callback behavior
- Delivery path (forRetrieval=false) callback triggers processOutbound() for pending messages
- Retrieval path (forRetrieval=true) callback triggers requestMessageList() (existing behavior preserved)
- PropagatedDeliveryTest submission test requires SENT or DELIVERED (not OUTBOUND)
- PropagatedDeliveryTest retrieval tests still pass (validates retrieval path not broken)
- All delivery interop tests pass
- Gap from 08.1-VERIFICATION.md is closed
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-tcp-interface-interop/08.1-04-SUMMARY.md`
</output>
