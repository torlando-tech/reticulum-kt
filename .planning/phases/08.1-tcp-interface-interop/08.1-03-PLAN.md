---
phase: 08.1-tcp-interface-interop
plan: 03
type: execute
wave: 3
depends_on: ["08.1-02"]
files_modified:
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTest.kt
autonomous: true

must_haves:
  truths:
    - "Direct delivery tests require DELIVERED state (not flexible SENT|DELIVERED)"
    - "Propagated delivery tests verify actual message submission and retrieval"
    - "All E2E tests pass with strict assertions"
  artifacts:
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt"
      provides: "Direct delivery tests with strict assertions"
      contains: "shouldBe MessageState.DELIVERED"
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTest.kt"
      provides: "Propagated delivery tests with strict assertions"
      contains: "shouldBe MessageState.DELIVERED"
  key_links:
    - from: "LiveDeliveryTest"
      to: "TCPClientInterface"
      via: "Fixed TCP transport layer"
      pattern: "TCPClientInterface"
---

<objective>
Update E2E delivery tests to use strict assertions now that TCP transport is fixed.

Purpose: Remove the flexible assertions that were added as workarounds for TCP interface limitations. With TCP transport working correctly, tests should assert the expected behavior: messages reach DELIVERED state, not just SENT or OUTBOUND.

Output:
- LiveDeliveryTest with strict assertions (DELIVERED state required)
- PropagatedDeliveryTest with strict assertions (actual message round-trip verified)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.1-tcp-interface-interop/08.1-RESEARCH.md

# IMPORTANT: Read Plan 01 and 02 SUMMARYs for context
@.planning/phases/08.1-tcp-interface-interop/08.1-01-SUMMARY.md
@.planning/phases/08.1-tcp-interface-interop/08.1-02-SUMMARY.md

# Current test implementations (with flexible assertions)
@lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt
@lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tighten LiveDeliveryTest assertions</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LiveDeliveryTest.kt</files>
  <action>
Update LiveDeliveryTest to use strict assertions instead of flexible ones.

Changes to make:
1. **delivery callback fires on successful K to P delivery test**:
   - Change: `listOf(MessageState.SENT, MessageState.DELIVERED) shouldContain finalState`
   - To: `finalState shouldBe MessageState.DELIVERED`
   - The callback should fire when delivery is confirmed, not just sent

2. **MessageState transitions correctly during delivery lifecycle test**:
   - Change: `listOf(MessageState.SENT, MessageState.DELIVERED) shouldContain finalState`
   - To: `finalState shouldBe MessageState.DELIVERED`
   - Final state should be DELIVERED for successful direct delivery

3. **Increase wait times if needed** (based on Plan 02 findings):
   - If tests are timing-sensitive, increase `delay(2000)` to `delay(3000)`
   - The goal is reliable tests, not fast tests

4. **Add diagnostic output on failure**:
   - Before strict assertion, log current state
   - On failure, log all state transitions for debugging

Do NOT change the test logic - only tighten the assertions. If tests fail after tightening, that indicates a real TCP issue that needs fixing in Plan 02.
  </action>
  <verify>
Tests compile: `./gradlew :lxmf-core:compileTestKotlin`
Run tests (expecting pass after TCP fixes): `./gradlew :lxmf-core:test --tests "LiveDeliveryTest"`
  </verify>
  <done>
LiveDeliveryTest requires MessageState.DELIVERED for successful delivery tests, not flexible SENT|DELIVERED.
  </done>
</task>

<task type="auto">
  <name>Task 2: Tighten PropagatedDeliveryTest assertions</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTest.kt</files>
  <action>
Update PropagatedDeliveryTest to verify actual end-to-end message delivery.

Review the current test and identify any flexible assertions that were added as workarounds:
1. Look for comments mentioning "TCP interface limitations" or "flexible assertions"
2. Look for assertions that accept multiple states (SENT|DELIVERED|OUTBOUND)
3. Look for tests that verify "Kotlin-side logic" but not actual delivery

For each flexible assertion found:
1. Replace with strict assertion (DELIVERED for successful delivery)
2. If the test was bypassing network round-trip, update to verify actual message receipt
3. Add appropriate wait times for network propagation

If PropagatedDeliveryTest already has strict assertions (just noting TCP limitations in comments), update the comments to reflect that TCP is now fixed.
  </action>
  <verify>
Tests compile: `./gradlew :lxmf-core:compileTestKotlin`
Run tests (expecting pass after TCP fixes): `./gradlew :lxmf-core:test --tests "PropagatedDeliveryTest"`
  </verify>
  <done>
PropagatedDeliveryTest verifies actual end-to-end propagated delivery with strict assertions.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run full LXMF interop test suite: `./gradlew :lxmf-core:test --tests "*.interop.*"`
2. Verify all tests pass with strict assertions
3. Check no tests are using flexible assertions as workarounds

Success means the TCP interface issues identified in Phase 8 are resolved.
</verification>

<success_criteria>
- LiveDeliveryTest requires DELIVERED state for successful delivery
- PropagatedDeliveryTest verifies actual message round-trip
- All interop tests pass (no flexible assertion workarounds)
- Test output shows clean delivery flow without TCP-related issues
</success_criteria>

<output>
After completion, create `.planning/phases/08.1-tcp-interface-interop/08.1-03-SUMMARY.md`
</output>
