---
phase: 08-propagated-delivery
plan: 02
type: execute
wave: 1
depends_on: ["08-01"]
files_modified:
  - lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMRouter.kt
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTestBase.kt
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Kotlin client can submit message to Python propagation node"
    - "Kotlin client can retrieve message from Python propagation node"
    - "Propagation node rejects message with insufficient stamp"
    - "End-to-end content integrity verified through propagated delivery"
  artifacts:
    - path: "lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMRouter.kt"
      provides: "addPropagationNode() method for direct node registration"
      contains: "fun addPropagationNode"
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTestBase.kt"
      provides: "Updated setup that uses addPropagationNode"
      contains: "addPropagationNode"
  key_links:
    - from: "PropagatedDeliveryTestBase.kt"
      to: "LXMRouter.kt"
      via: "addPropagationNode() call"
      pattern: "kotlinRouter\\.addPropagationNode"
---

<objective>
Close the gap preventing Kotlin from registering Python propagation nodes for PROPAGATED delivery.

Purpose: The verification found that `setActivePropagationNode()` fails because nodes must first exist in the `propagationNodes` map. The announce flow from Python doesn't populate this map correctly for test scenarios. This plan adds a direct `addPropagationNode()` method that bypasses the announce flow.

Output: LXMRouter with `addPropagationNode()` method, updated test base that uses it, and all 4 propagated delivery tests working with actual message submission/retrieval.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-propagated-delivery/08-01-SUMMARY.md
@.planning/phases/08-propagated-delivery/08-VERIFICATION.md
@lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMRouter.kt
@lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTestBase.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add addPropagationNode method to LXMRouter</name>
  <files>lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMRouter.kt</files>
  <action>
Add a public method `addPropagationNode()` to LXMRouter that directly adds a PropagationNode to the internal `propagationNodes` map.

Location: Add after `getPropagationNodes()` method (around line 1426)

```kotlin
/**
 * Add a propagation node directly to the known nodes map.
 *
 * This method bypasses the announce flow and is useful for testing
 * or when the propagation node details are known through other means.
 *
 * @param node The propagation node to add
 */
fun addPropagationNode(node: PropagationNode) {
    propagationNodes[node.hexHash] = node
    println("Added propagation node: ${node.hexHash} (${node.displayName ?: "unnamed"})")
}
```

This allows tests to manually register propagation nodes without relying on the announce parsing flow, which may not work correctly when the Python bridge uses different message formats.
  </action>
  <verify>
Compile check:
```bash
cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :lxmf-core:compileKotlin
```
  </verify>
  <done>
LXMRouter has `addPropagationNode(node: PropagationNode)` method that adds nodes to the internal map.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update PropagatedDeliveryTestBase to use addPropagationNode</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/PropagatedDeliveryTestBase.kt</files>
  <action>
Update the `setupDirectDelivery()` method to:

1. Create the PropagationNode object (already done at lines 61-68)
2. Call `kotlinRouter.addPropagationNode(node)` BEFORE calling `setActivePropagationNode()`
3. Remove the try/catch around `setActivePropagationNode()` since it should now succeed

Replace lines 70-79 (the current try/catch block) with:

```kotlin
// Add the propagation node to the router's known nodes
kotlinRouter.addPropagationNode(node)

// Now set it as active (this will succeed because node is in map)
val nodeSet = kotlinRouter.setActivePropagationNode(propagationNodeHash!!.toHex())
if (nodeSet) {
    println("  [Setup] Active propagation node set: ${propagationNodeHash!!.toHex()}")
} else {
    println("  [Setup] WARNING: Failed to set active propagation node")
}
```

This ensures the node is added to the map before attempting to set it as active, which is exactly what the verification identified as the missing step.
  </action>
  <verify>
Run propagated delivery tests:
```bash
cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :lxmf-core:test --tests "*PropagatedDelivery*" --info 2>&1 | tail -100
```
  </verify>
  <done>
PropagatedDeliveryTestBase correctly adds propagation node before setting it active, and tests show successful propagation node setup (no more "Cannot set inactive or unknown propagation node" errors).
  </done>
</task>

</tasks>

<verification>
Run full propagated delivery test suite and verify logs show successful propagation node setup:

```bash
cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :lxmf-core:test --tests "*PropagatedDelivery*" --info 2>&1 | grep -E "(propagation|Propagation|PASSED|FAILED)"
```

Expected outcomes:
1. "Added propagation node:" appears in logs (from addPropagationNode)
2. "Active propagation node set:" appears in logs (setActivePropagationNode succeeds)
3. No more "Cannot set inactive or unknown propagation node" errors
4. Tests that previously showed "No active propagation node for message delivery" now attempt actual delivery
</verification>

<success_criteria>
1. LXMRouter compiles with new addPropagationNode() method
2. PropagatedDeliveryTestBase uses addPropagationNode before setActivePropagationNode
3. Test logs show "Added propagation node:" and "Active propagation node set:"
4. No "Cannot set inactive or unknown propagation node" errors in test output
5. All 4 propagated delivery tests continue to pass
6. Messages can now reach SENT state (not stuck in OUTBOUND)
</success_criteria>

<output>
After completion, create `.planning/phases/08-propagated-delivery/08-02-SUMMARY.md`
</output>
