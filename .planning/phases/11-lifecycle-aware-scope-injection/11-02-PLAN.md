---
phase: 11-lifecycle-aware-scope-injection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - rns-interfaces/src/main/kotlin/network/reticulum/interfaces/udp/UDPInterface.kt
autonomous: true

must_haves:
  truths:
    - "UDPInterface accepts optional parentScope parameter"
    - "When parentScope is null, interface creates standalone scope (backward compatible)"
    - "When parentScope provided, interface creates child scope that cancels when parent cancels"
    - "Existing UDP tests continue passing without modification"
  artifacts:
    - path: "rns-interfaces/src/main/kotlin/network/reticulum/interfaces/udp/UDPInterface.kt"
      provides: "parentScope parameter and child scope creation"
      contains: "parentScope: CoroutineScope? = null"
  key_links:
    - from: "UDPInterface constructor"
      to: "internal ioScope"
      via: "child scope creation with SupervisorJob"
      pattern: "parentScope.*\\+.*SupervisorJob"
---

<objective>
Add optional parentScope parameter to UDPInterface enabling lifecycle-aware scope injection from Android services while preserving backward compatibility for standalone JVM usage and existing tests.

Purpose: Enable proper coroutine cancellation when Android service stops, preventing leaks while maintaining JVM test compatibility.
Output: UDPInterface with parentScope parameter and child scope creation logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-lifecycle-aware-scope-injection/11-CONTEXT.md

# Reference implementation
@rns-interfaces/src/main/kotlin/network/reticulum/interfaces/udp/UDPInterface.kt

# Existing tests (must continue working)
@rns-interfaces/src/test/kotlin/network/reticulum/interfaces/udp/UDPInterfaceTest.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parentScope parameter and child scope creation</name>
  <files>rns-interfaces/src/main/kotlin/network/reticulum/interfaces/udp/UDPInterface.kt</files>
  <action>
Add parentScope parameter to UDPInterface constructor:
- Parameter: `parentScope: CoroutineScope? = null` as the LAST constructor parameter
- Position after multicastTtl parameter (preserves existing call sites)

Replace the fixed ioScope creation:
```kotlin
// OLD:
private val ioScope = CoroutineScope(SupervisorJob() + Dispatchers.IO)

// NEW:
private val ioScope: CoroutineScope = createScope(parentScope)

private fun createScope(parent: CoroutineScope?): CoroutineScope {
    return if (parent != null) {
        // Child scope: cancels when parent cancels, but can cancel independently
        CoroutineScope(parent.coroutineContext + SupervisorJob(parent.coroutineContext[Job]) + Dispatchers.IO)
    } else {
        // Standalone scope: lives until explicitly cancelled
        CoroutineScope(SupervisorJob() + Dispatchers.IO)
    }
}
```

Key implementation details:
- SupervisorJob as parent's child enables independent cancellation
- Dispatchers.IO preserved for blocking socket operations
- Null parentScope = standalone mode (current behavior)
- Child scope pattern allows interface to cancel its own work without affecting siblings
  </action>
  <verify>
Compile check: `cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-interfaces:compileKotlin --no-daemon`
  </verify>
  <done>UDPInterface compiles with parentScope parameter defaulting to null</done>
</task>

<task type="auto">
  <name>Task 2: Add stop() method and parent cancellation listener</name>
  <files>rns-interfaces/src/main/kotlin/network/reticulum/interfaces/udp/UDPInterface.kt</files>
  <action>
Add public stop() method that triggers same cleanup as scope cancellation for explicit control in JVM tests and non-Android usage:

```kotlin
/**
 * Stop the interface gracefully.
 * Cancels all coroutines and closes sockets.
 * This is the explicit cleanup path - called directly in JVM usage
 * or triggered automatically when parent scope is cancelled.
 */
fun stop() {
    detach()
}
```

The existing detach() method already:
1. Sets running and online to false
2. Cancels readJob and ioScope
3. Calls cleanup() to close sockets

The stop() method provides a cleaner API name while leveraging existing cleanup.

Also add scope cancellation listener for parent-triggered cleanup:
```kotlin
init {
    // If we have a parent scope, listen for its cancellation
    parentScope?.coroutineContext?.get(Job)?.invokeOnCompletion { cause ->
        if (cause != null || !ioScope.isActive) {
            // Parent was cancelled (or our scope is already done)
            // Trigger graceful shutdown
            detach()
        }
    }
}
```

This ensures that when the parent scope (serviceScope) is cancelled, the interface cleans up automatically.
  </action>
  <verify>
Compile check: `cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-interfaces:compileKotlin --no-daemon`
  </verify>
  <done>UDPInterface has stop() method and parent scope cancellation listener</done>
</task>

<task type="auto">
  <name>Task 3: Verify existing tests pass</name>
  <files>rns-interfaces/src/test/kotlin/network/reticulum/interfaces/udp/UDPInterfaceTest.kt</files>
  <action>
Run existing UDP tests to confirm backward compatibility:
- All tests in UDPInterfaceTest should pass without modification
- Tests create UDPInterface without parentScope parameter
- Default null value means standalone mode (original behavior)

No code changes needed - this is purely verification.
  </action>
  <verify>
Run tests: `cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-interfaces:test --tests "network.reticulum.interfaces.udp.UDPInterfaceTest" --no-daemon`
  </verify>
  <done>All existing UDP tests pass with no modifications</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run compile: `JAVA_HOME=~/android-studio/jbr ./gradlew :rns-interfaces:compileKotlin --no-daemon`
2. Run all UDP tests: `JAVA_HOME=~/android-studio/jbr ./gradlew :rns-interfaces:test --tests "network.reticulum.interfaces.udp.*" --no-daemon`
3. Verify test count matches before (no tests removed or broken)

Expected: All 15+ existing UDP tests continue to pass.
</verification>

<success_criteria>
- UDPInterface compiles with parentScope parameter
- Default null value preserves backward compatibility
- Child scope created when parent provided
- stop() method available for explicit cleanup
- Parent scope cancellation triggers interface cleanup
- All existing UDP tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/11-lifecycle-aware-scope-injection/11-02-SUMMARY.md`
</output>
