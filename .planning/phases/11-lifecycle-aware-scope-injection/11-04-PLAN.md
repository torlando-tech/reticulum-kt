---
phase: 11-lifecycle-aware-scope-injection
plan: 04
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt
autonomous: true

must_haves:
  truths:
    - "InterfaceManager passes parentScope when creating TCPClientInterface"
    - "InterfaceManager passes parentScope when creating AutoInterface (if supported)"
    - "Service stop triggers automatic cleanup of all interface coroutines via scope cancellation"
    - "Production code uses the scope injection feature built in 11-01 and 11-02"
  artifacts:
    - path: "rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt"
      provides: "Production wiring of parentScope to interfaces"
      contains: "parentScope = scope"
  key_links:
    - from: "InterfaceManager.scope"
      to: "TCPClientInterface parentScope parameter"
      via: "constructor argument"
      pattern: "TCPClientInterface\\([^)]*parentScope\\s*="
---

<objective>
Wire InterfaceManager to pass its coroutine scope to interfaces as parentScope, enabling lifecycle-aware cancellation in production Android usage.

Purpose: Without this wiring, the scope injection feature built in plans 11-01 and 11-02 would exist but never be used. This plan connects the service scope to the interfaces, fulfilling the phase goal of service-to-interface lifecycle propagation.
Output: InterfaceManager that passes parentScope when creating interfaces.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-lifecycle-aware-scope-injection/11-CONTEXT.md

# InterfaceManager to modify
@rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt

# Modified interfaces (from plans 01 and 02)
@rns-interfaces/src/main/kotlin/network/reticulum/interfaces/tcp/TCPClientInterface.kt
@rns-interfaces/src/main/kotlin/network/reticulum/interfaces/udp/UDPInterface.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass parentScope to TCPClientInterface in InterfaceManager</name>
  <files>rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt</files>
  <action>
Update the `startInterface` method to pass `parentScope = scope` when creating TCPClientInterface.

Find the TCP_CLIENT case in startInterface():
```kotlin
InterfaceType.TCP_CLIENT -> {
    val host = config.host ?: return null
    val port = config.port ?: 4242

    try {
        val iface = TCPClientInterface(
            name = config.name,
            targetHost = host,
            targetPort = port,
            ifacNetname = config.networkName,
            ifacNetkey = config.passphrase,
        )
```

Change to:
```kotlin
InterfaceType.TCP_CLIENT -> {
    val host = config.host ?: return null
    val port = config.port ?: 4242

    try {
        val iface = TCPClientInterface(
            name = config.name,
            targetHost = host,
            targetPort = port,
            ifacNetname = config.networkName,
            ifacNetkey = config.passphrase,
            parentScope = scope,  // Wire service scope for lifecycle-aware cancellation
        )
```

This ensures that when the service scope is cancelled (service stops), the TCP interface automatically cleans up its coroutines.
  </action>
  <verify>
Compile check: `cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-sample-app:compileDebugKotlin --no-daemon`
  </verify>
  <done>TCPClientInterface created with parentScope in InterfaceManager</done>
</task>

<task type="auto">
  <name>Task 2: Update stopInterface to use new stop() method</name>
  <files>rns-sample-app/src/main/kotlin/tech/torlando/reticulumkt/service/InterfaceManager.kt</files>
  <action>
The `stopInterface` method currently calls `detach()` directly. Update to use the new `stop()` method if available, with a fallback to detach() for interfaces that don't have stop():

```kotlin
private fun stopInterface(id: String, iface: Interface) {
    try {
        // Deregister from Transport first
        Transport.deregisterInterface(InterfaceAdapter.getOrCreate(iface))

        // Use stop() if available (TCPClientInterface, UDPInterface)
        // or fall back to detach() for other interface types
        when (iface) {
            is TCPClientInterface -> iface.stop()
            // Add UDPInterface when used in production
            else -> iface.detach()
        }

        Log.i(TAG, "Stopped interface: ${iface.name}")
    } catch (e: Exception) {
        Log.e(TAG, "Error stopping interface ${iface.name}: ${e.message}")
    }
}
```

Note: While `stop()` just calls `detach()` internally, using the explicit API name makes intent clearer and future-proofs the code if stop() gains additional behavior.

Also note: With parentScope wiring, explicit stopInterface calls become a backup path - the primary cleanup happens automatically when the service scope is cancelled.
  </action>
  <verify>
Compile check: `cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-sample-app:compileDebugKotlin --no-daemon`
  </verify>
  <done>stopInterface uses new stop() method for TCPClientInterface</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run compile: `JAVA_HOME=~/android-studio/jbr ./gradlew :rns-sample-app:compileDebugKotlin --no-daemon`
2. Verify the code compiles without errors
3. Optional: Run on device to verify service stop triggers interface cleanup (manual verification)

The automated tests in 11-03 verify the scope injection behavior. This plan ensures it's actually used in production.
</verification>

<success_criteria>
- InterfaceManager passes parentScope to TCPClientInterface
- InterfaceManager uses stop() method in stopInterface
- Android app compiles successfully
- Production interfaces will now automatically clean up when service stops
</success_criteria>

<output>
After completion, create `.planning/phases/11-lifecycle-aware-scope-injection/11-04-SUMMARY.md`
</output>
