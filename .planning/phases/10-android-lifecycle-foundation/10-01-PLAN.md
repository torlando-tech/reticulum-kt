---
phase: 10-android-lifecycle-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rns-android/src/main/AndroidManifest.xml
  - rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt
  - rns-android/src/main/kotlin/network/reticulum/android/NotificationChannels.kt
autonomous: true

must_haves:
  truths:
    - "Service declares connectedDevice foreground service type in manifest"
    - "Service starts with connectedDevice type on API 29+"
    - "Two notification channels exist: service (low) and alerts (default)"
    - "Notification channel configuration is injectable for testing"
  artifacts:
    - path: "rns-android/src/main/AndroidManifest.xml"
      provides: "connectedDevice permission and service type declaration"
      contains: "FOREGROUND_SERVICE_CONNECTED_DEVICE"
    - path: "rns-android/src/main/kotlin/network/reticulum/android/NotificationChannels.kt"
      provides: "Notification channel factory with both channels"
      exports: ["NotificationChannels", "createServiceChannel", "createAlertsChannel"]
    - path: "rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt"
      provides: "Updated foreground service type usage"
      contains: "FOREGROUND_SERVICE_TYPE_CONNECTED_DEVICE"
  key_links:
    - from: "ReticulumService.kt"
      to: "NotificationChannels"
      via: "channel creation on service start"
      pattern: "NotificationChannels"
---

<objective>
Update foreground service configuration to use connectedDevice type and create dual notification channels.

Purpose: Phase 10 establishes lifecycle observation infrastructure. This plan sets up the service type for P2P mesh networking (connectedDevice is correct for TCP/UDP mesh) and creates notification channels for service status (low priority) and important alerts (default priority with sound).

Output:
- AndroidManifest with connectedDevice permission and service type
- NotificationChannels.kt with channel creation logic
- ReticulumService updated to use connectedDevice type on API 29+
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@rns-android/src/main/AndroidManifest.xml
@rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt
@rns-android/src/main/kotlin/network/reticulum/android/NotificationHelper.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AndroidManifest for connectedDevice service type</name>
  <files>rns-android/src/main/AndroidManifest.xml</files>
  <action>
Update the AndroidManifest.xml to use connectedDevice foreground service type:

1. Replace the permission:
   - Remove: `android.permission.FOREGROUND_SERVICE_DATA_SYNC`
   - Add: `android.permission.FOREGROUND_SERVICE_CONNECTED_DEVICE`

2. Update the service declaration:
   - Change `android:foregroundServiceType="dataSync"` to `android:foregroundServiceType="connectedDevice"`

Rationale: connectedDevice is the correct foreground service type for P2P mesh networking over TCP/UDP. dataSync is for cloud sync operations and may be restricted on some OEMs.
  </action>
  <verify>
Verify the manifest changes:
```bash
grep -E "FOREGROUND_SERVICE|foregroundServiceType" rns-android/src/main/AndroidManifest.xml
```
Should show `FOREGROUND_SERVICE_CONNECTED_DEVICE` permission and `connectedDevice` service type.
  </verify>
  <done>
Manifest declares connectedDevice permission and service type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationChannels with dual-channel setup</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/NotificationChannels.kt</files>
  <action>
Create a new NotificationChannels.kt file that provides channel creation:

```kotlin
package network.reticulum.android

import android.app.NotificationChannel
import android.app.NotificationManager
import android.content.Context
import android.media.AudioAttributes

/**
 * Notification channel configuration for Reticulum service.
 *
 * Creates two channels:
 * - Service channel: Low importance, no sound/vibration, for persistent service notification
 * - Alerts channel: Default importance, with sound, for disconnect warnings and important events
 */
object NotificationChannels {

    const val SERVICE_CHANNEL_ID = "reticulum_service"
    const val ALERTS_CHANNEL_ID = "reticulum_alerts"

    /**
     * Create all notification channels.
     * Safe to call multiple times - Android ignores duplicate channel creation.
     *
     * @param context Application or service context
     * @param serviceImportance Override importance for service channel (default: LOW)
     * @param alertsImportance Override importance for alerts channel (default: DEFAULT)
     */
    fun createChannels(
        context: Context,
        serviceImportance: Int = NotificationManager.IMPORTANCE_LOW,
        alertsImportance: Int = NotificationManager.IMPORTANCE_DEFAULT
    ) {
        val notificationManager = context.getSystemService(NotificationManager::class.java)

        notificationManager.createNotificationChannel(
            createServiceChannel(serviceImportance)
        )
        notificationManager.createNotificationChannel(
            createAlertsChannel(alertsImportance)
        )
    }

    /**
     * Create the service notification channel.
     *
     * Low importance by default - shows in notification shade but no sound/vibration.
     * User can configure importance in system settings after channel creation.
     */
    fun createServiceChannel(
        importance: Int = NotificationManager.IMPORTANCE_LOW
    ): NotificationChannel {
        return NotificationChannel(
            SERVICE_CHANNEL_ID,
            "Reticulum Service",
            importance
        ).apply {
            description = "Persistent notification for mesh network connection"
            setShowBadge(false)
            enableLights(false)
            enableVibration(false)
            setSound(null, null)
        }
    }

    /**
     * Create the alerts notification channel.
     *
     * Default importance - shows in shade with sound for important events like:
     * - Disconnect warnings
     * - Connection failures requiring attention
     * - Network transitions that may affect connectivity
     */
    fun createAlertsChannel(
        importance: Int = NotificationManager.IMPORTANCE_DEFAULT
    ): NotificationChannel {
        return NotificationChannel(
            ALERTS_CHANNEL_ID,
            "Reticulum Alerts",
            importance
        ).apply {
            description = "Important alerts about connection status"
            setShowBadge(true)
            enableLights(true)
            enableVibration(true)
            // Use default notification sound
            setSound(
                android.provider.Settings.System.DEFAULT_NOTIFICATION_URI,
                AudioAttributes.Builder()
                    .setUsage(AudioAttributes.USAGE_NOTIFICATION)
                    .setContentType(AudioAttributes.CONTENT_TYPE_SONIFICATION)
                    .build()
            )
        }
    }
}
```

Key design choices:
- Object singleton for simple static access
- Configurable importance levels for testing/customization
- Separate factory methods for individual channel creation (useful for testing)
- Service channel: no sound/vibration/badge (silent persistent notification)
- Alerts channel: sound/vibration/badge (user attention needed)
  </action>
  <verify>
Verify the file compiles:
```bash
cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin 2>&1 | tail -20
```
Should compile without errors.
  </verify>
  <done>
NotificationChannels.kt exists with both channel factories and configurable importance.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ReticulumService to use connectedDevice type and new channels</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt</files>
  <action>
Update ReticulumService.kt:

1. Change the foreground service type from DATA_SYNC to CONNECTED_DEVICE:
   - Import: `android.content.pm.ServiceInfo.FOREGROUND_SERVICE_TYPE_CONNECTED_DEVICE`
   - In `onStartCommand`, change `ServiceInfo.FOREGROUND_SERVICE_TYPE_DATA_SYNC` to `ServiceInfo.FOREGROUND_SERVICE_TYPE_CONNECTED_DEVICE`

2. Update `createNotificationChannel()` to use NotificationChannels:
   - Replace the inline channel creation with `NotificationChannels.createChannels(this)`
   - Update CHANNEL_ID reference to use `NotificationChannels.SERVICE_CHANNEL_ID`

3. Update `createNotification()` to use the correct channel ID:
   - Change `CHANNEL_ID` to `NotificationChannels.SERVICE_CHANNEL_ID`

4. Remove the old CHANNEL_ID constant from companion object (now in NotificationChannels).

The changes preserve backward compatibility - existing notifications continue to work, just using the new channel constants.
  </action>
  <verify>
Build and verify:
```bash
cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin 2>&1 | tail -20
```

Check the service uses correct type:
```bash
grep -E "FOREGROUND_SERVICE_TYPE|CONNECTED_DEVICE" rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt
```
Should show FOREGROUND_SERVICE_TYPE_CONNECTED_DEVICE.
  </verify>
  <done>
ReticulumService uses connectedDevice type and NotificationChannels for channel creation.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Manifest check:
```bash
grep -E "FOREGROUND_SERVICE|foregroundServiceType" rns-android/src/main/AndroidManifest.xml
```
Expected: FOREGROUND_SERVICE_CONNECTED_DEVICE and connectedDevice

2. Compilation check:
```bash
cd ~/repos/public/reticulum-kt && JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin
```
Expected: BUILD SUCCESSFUL

3. Service type check:
```bash
grep "FOREGROUND_SERVICE_TYPE" rns-android/src/main/kotlin/network/reticulum/android/ReticulumService.kt
```
Expected: FOREGROUND_SERVICE_TYPE_CONNECTED_DEVICE

4. Channel IDs check:
```bash
grep "CHANNEL_ID" rns-android/src/main/kotlin/network/reticulum/android/NotificationChannels.kt
```
Expected: SERVICE_CHANNEL_ID and ALERTS_CHANNEL_ID
</verification>

<success_criteria>
- AndroidManifest declares FOREGROUND_SERVICE_CONNECTED_DEVICE permission
- AndroidManifest declares connectedDevice foreground service type
- NotificationChannels.kt exists with dual-channel factory methods
- ReticulumService uses FOREGROUND_SERVICE_TYPE_CONNECTED_DEVICE
- ReticulumService uses NotificationChannels for channel creation
- All code compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/10-android-lifecycle-foundation/10-01-SUMMARY.md`
</output>
