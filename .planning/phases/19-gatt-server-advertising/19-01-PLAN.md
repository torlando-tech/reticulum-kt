---
phase: 19-gatt-server-advertising
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rns-android/src/main/kotlin/network/reticulum/android/ble/BleGattServer.kt
  - rns-android/src/main/AndroidManifest.xml

autonomous: true

must_haves:
  truths:
    - "GATT server hosts service UUID 37145b00-442d-4a94-917f-8f42c5da28e3 with RX, TX, and Identity characteristics"
    - "RX characteristic accepts WRITE and WRITE_WITHOUT_RESPONSE from centrals"
    - "TX characteristic supports NOTIFY with CCCD descriptor for notification subscription"
    - "Identity characteristic serves 16-byte Transport identity hash as read-only"
    - "sendResponse() is always called when responseNeeded=true in write/read callbacks"
    - "Notifications are serialized via onNotificationSent callback (CompletableDeferred)"
    - "Per-device MTU tracked from onMtuChanged callbacks with Map<String, Int>"
    - "Per-device CCCD subscription state tracked -- notifications only sent to subscribed devices"
    - "API 33 compatibility for notifyCharacteristicChanged (new 4-param vs deprecated 3-param)"
  artifacts:
    - path: "rns-android/src/main/kotlin/network/reticulum/android/ble/BleGattServer.kt"
      provides: "GATT server hosting Reticulum service, callback handling, notification serialization, per-device state"
      exports: ["BleGattServer"]
    - path: "rns-android/src/main/AndroidManifest.xml"
      provides: "BLE permissions (BLUETOOTH_CONNECT, BLUETOOTH_ADVERTISE, BLUETOOTH_SCAN)"
      contains: "BLUETOOTH_CONNECT"
  key_links:
    - from: "BleGattServer.kt"
      to: "BLEConstants.kt"
      via: "imports SERVICE_UUID, RX_CHAR_UUID, TX_CHAR_UUID, IDENTITY_CHAR_UUID, CCCD_UUID"
      pattern: "BLEConstants"
    - from: "BleGattServer.kt"
      to: "rns-android/build.gradle.kts"
      via: "rns-android depends on rns-interfaces (api(project(':rns-interfaces')))"
      pattern: "rns-interfaces"
---

<objective>
Implement BleGattServer.kt -- the GATT server that hosts the Reticulum BLE service and handles all incoming central connections.

Purpose: This is the core peripheral-mode component. It hosts the GATT service with RX/TX/Identity characteristics, handles all GATT callbacks (reads, writes, MTU changes, CCCD subscriptions), serializes notification sends, and tracks per-device state. Without this, the device cannot accept incoming BLE connections from other Reticulum peers.

Output: `BleGattServer.kt` in rns-android module's new `ble/` package, plus BLE permissions in AndroidManifest.xml.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-gatt-server-advertising/19-CONTEXT.md
@.planning/phases/19-gatt-server-advertising/19-RESEARCH.md

# Reference implementations (read these for patterns):
@~/repos/columba/reticulum/src/main/java/com/lxmf/messenger/reticulum/ble/server/BleGattServer.kt
@~/repos/ble-reticulum/src/ble_reticulum/BLEGATTServer.py

# Phase 18 outputs (use BLEConstants for all UUIDs and constants):
@rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/BLEConstants.kt
@rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/BLEDriver.kt

# Existing Android module structure:
@rns-android/build.gradle.kts
@rns-android/src/main/AndroidManifest.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BLE permissions to AndroidManifest.xml</name>
  <files>rns-android/src/main/AndroidManifest.xml</files>
  <action>
Add BLE-specific permissions to the rns-android AndroidManifest.xml. These are needed for GATT server, advertising, and scanning.

Add BEFORE the existing `<uses-permission>` block:
```xml
<!-- BLE permissions (Android 12+) -->
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
<uses-permission android:name="android.permission.BLUETOOTH_ADVERTISE" />
<uses-permission android:name="android.permission.BLUETOOTH_SCAN"
    android:usesPermissionFlags="neverForLocation" />

<!-- BLE permissions (Android 11 and below) -->
<uses-permission android:name="android.permission.BLUETOOTH"
    android:maxSdkVersion="30" />
<uses-permission android:name="android.permission.BLUETOOTH_ADMIN"
    android:maxSdkVersion="30" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"
    android:maxSdkVersion="30" />
```

Also add BLE feature declaration:
```xml
<uses-feature android:name="android.hardware.bluetooth_le" android:required="false" />
```

Use `android:maxSdkVersion="30"` on the legacy permissions so they only apply to Android 11 and below. The `neverForLocation` flag on BLUETOOTH_SCAN avoids the location permission requirement on Android 12+.
  </action>
  <verify>The manifest XML is valid (no syntax errors). Check with `grep -c BLUETOOTH_CONNECT rns-android/src/main/AndroidManifest.xml` returns 1.</verify>
  <done>AndroidManifest.xml declares all 6 BLE permissions (3 for API 31+, 3 for API 30-) plus the BLE hardware feature.</done>
</task>

<task type="auto">
  <name>Task 2: Implement BleGattServer.kt</name>
  <files>rns-android/src/main/kotlin/network/reticulum/android/ble/BleGattServer.kt</files>
  <action>
Create `BleGattServer.kt` in a new `ble/` package under `network.reticulum.android.ble`.

**Follow Columba's BleGattServer.kt closely** but adapt for this project's architecture. Key differences from Columba:
- Use `BLEConstants` from `network.reticulum.interfaces.ble` (not Columba's BleConstants)
- Use `SharedFlow` events instead of nullable function callbacks for connection/disconnect/data events
- Add notification serialization via CompletableDeferred (Columba is missing this)
- Don't include keepalive logic (that's Phase 21's BLEInterface concern)
- Don't include identity handshake interpretation (that's Phase 21 -- just emit the raw data)

**Class signature:**
```kotlin
class BleGattServer(
    private val context: Context,
    private val bluetoothManager: BluetoothManager,
    private val scope: CoroutineScope = CoroutineScope(Dispatchers.Default + SupervisorJob()),
)
```

**GATT Service (createReticulumService()):**
Create a primary service with three characteristics exactly matching the protocol spec:

1. **RX Characteristic** (BLEConstants.RX_CHAR_UUID):
   - Properties: PROPERTY_WRITE | PROPERTY_WRITE_NO_RESPONSE
   - Permissions: PERMISSION_WRITE

2. **TX Characteristic** (BLEConstants.TX_CHAR_UUID):
   - Properties: PROPERTY_READ | PROPERTY_NOTIFY
   - Permissions: PERMISSION_READ
   - Add CCCD descriptor (BLEConstants.CCCD_UUID) with PERMISSION_READ | PERMISSION_WRITE

3. **Identity Characteristic** (BLEConstants.IDENTITY_CHAR_UUID):
   - Properties: PROPERTY_READ
   - Permissions: PERMISSION_READ

**Per-device state (all protected by Mutex):**
- `connectedCentrals: MutableMap<String, BluetoothDevice>` -- address to device
- `centralMtus: MutableMap<String, Int>` -- address to usable MTU (ATT MTU - 3)
- `notificationSubscriptions: MutableMap<String, Boolean>` -- address to CCCD enabled state

**BluetoothGattServerCallback implementation:**
ALL callbacks dispatch to `scope.launch { ... }` to avoid blocking the binder thread.

1. **onConnectionStateChange**: Track centrals. On STATE_CONNECTED: add to connectedCentrals, set default MTU to BLEConstants.MIN_MTU, emit event. On STATE_DISCONNECTED: remove from all maps, emit event.

2. **onCharacteristicReadRequest**:
   - TX char: sendResponse with empty byte array (notifications are the data mechanism)
   - Identity char: sendResponse with transportIdentityHash (16 bytes) or GATT_FAILURE if not set
   - Unknown: sendResponse with GATT_FAILURE
   - ALWAYS call sendResponse for read requests

3. **onCharacteristicWriteRequest**:
   - RX char: call sendResponse FIRST if responseNeeded, then emit data via SharedFlow
   - Unknown: sendResponse with GATT_FAILURE if responseNeeded
   - Per CONTEXT.md: silent drop on malformed/empty data (no disconnect)

4. **onDescriptorReadRequest**:
   - CCCD: return current subscription value
   - ALWAYS call sendResponse

5. **onDescriptorWriteRequest**:
   - CCCD: track subscription state in notificationSubscriptions map, sendResponse if needed
   - Unknown: sendResponse with GATT_FAILURE if needed

6. **onMtuChanged**: Store usable MTU (mtu - 3) in centralMtus map. Emit MTU change event.

7. **onNotificationSent**: Complete the CompletableDeferred for notification serialization.

8. **onServiceAdded**: Complete the CompletableDeferred for async service registration.

**Notification serialization (CRITICAL):**
Use a global CompletableDeferred per notification to serialize sends:
```kotlin
private var notificationDeferred: CompletableDeferred<Int>? = null
private val notificationMutex = Mutex()

suspend fun sendNotification(device: BluetoothDevice, data: ByteArray): Boolean {
    notificationMutex.withLock {
        // Check CCCD subscription
        if (notificationSubscriptions[device.address] != true) return false

        val deferred = CompletableDeferred<Int>()
        notificationDeferred = deferred

        val result = sendNotificationCompat(gattServer!!, device, txCharacteristic!!, data)
        if (result != BluetoothGatt.GATT_SUCCESS && result != 0) {
            notificationDeferred = null
            return false
        }

        // Wait for onNotificationSent
        val status = withTimeoutOrNull(BLEConstants.OPERATION_TIMEOUT_MS) { deferred.await() }
        notificationDeferred = null
        return status == BluetoothGatt.GATT_SUCCESS
    }
}
```
Note: The mutex is global (not per-device) because Android's BLE stack serializes notifications globally.

In `onNotificationSent`, complete the deferred:
```kotlin
override fun onNotificationSent(device: BluetoothDevice, status: Int) {
    notificationDeferred?.complete(status)
}
```

**API 33 compatibility (sendNotificationCompat):**
```kotlin
private fun sendNotificationCompat(
    server: BluetoothGattServer, device: BluetoothDevice,
    characteristic: BluetoothGattCharacteristic, data: ByteArray
): Int {
    return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
        server.notifyCharacteristicChanged(device, characteristic, false, data)
    } else {
        @Suppress("DEPRECATION")
        characteristic.value = data
        @Suppress("DEPRECATION")
        val success = server.notifyCharacteristicChanged(device, characteristic, false)
        if (success) BluetoothGatt.GATT_SUCCESS else BluetoothGatt.GATT_FAILURE
    }
}
```

**Public API:**
- `suspend fun open(): Result<Unit>` -- open GATT server, add service, wait for onServiceAdded (5s timeout)
- `suspend fun close()` -- close server, clear all state
- `fun setTransportIdentity(identityHash: ByteArray)` -- set 16-byte identity for Identity characteristic
- `suspend fun sendNotification(device: BluetoothDevice, data: ByteArray): Boolean` -- serialized notification send
- `suspend fun sendNotificationToAddress(address: String, data: ByteArray): Boolean` -- convenience wrapper
- `suspend fun getConnectedCentrals(): List<String>` -- list connected addresses
- `suspend fun getMtu(address: String): Int?` -- get per-device MTU
- `suspend fun isSubscribed(address: String): Boolean` -- check CCCD subscription
- `suspend fun disconnectCentral(address: String)` -- cancel connection
- `fun shutdown()` -- close server and cancel scope

**Event flows (SharedFlow, replay=0, extraBufferCapacity=16):**
- `val centralConnected: SharedFlow<String>` -- emits address on STATE_CONNECTED
- `val centralDisconnected: SharedFlow<String>` -- emits address on STATE_DISCONNECTED
- `val dataReceived: SharedFlow<Pair<String, ByteArray>>` -- emits (address, data) on RX write
- `val mtuChanged: SharedFlow<Pair<String, Int>>` -- emits (address, usableMtu)

**Permission check helper:**
```kotlin
private fun hasConnectPermission(): Boolean {
    return if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
        ContextCompat.checkSelfPermission(context, Manifest.permission.BLUETOOTH_CONNECT) == PackageManager.PERMISSION_GRANTED
    } else true
}
```

**Error handling per CONTEXT.md:**
- Silent drop on malformed RX writes (empty data)
- Report and stop on GATT server init failure (Result.failure from open())
- Minimal logging -- only log errors and disconnects (not every callback)

**Tag for logging:** `"BleGattServer"` (no vendor prefix)
  </action>
  <verify>
Build the rns-android module to verify compilation:
```
JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin
```
The file should compile without errors and import BLEConstants correctly from rns-interfaces.
  </verify>
  <done>
BleGattServer.kt exists at rns-android/src/main/kotlin/network/reticulum/android/ble/BleGattServer.kt with:
- GATT service creation with 3 characteristics matching protocol spec
- All 8 callback handlers dispatching via scope.launch
- sendResponse() called in every callback where responseNeeded=true or read request
- Notification serialization via global Mutex + CompletableDeferred
- Per-device MTU tracking in Map protected by Mutex
- Per-device CCCD subscription tracking
- API 33 compat for notifyCharacteristicChanged
- SharedFlow events for connection/disconnect/data/MTU
- Identity characteristic serves transportIdentityHash
  </done>
</task>

</tasks>

<verification>
1. `JAVA_HOME=~/android-studio/jbr ./gradlew :rns-android:compileDebugKotlin` succeeds
2. BleGattServer.kt imports BLEConstants from rns-interfaces (cross-module dependency works)
3. AndroidManifest.xml contains all 6 BLE permissions
4. GATT service has exactly 3 characteristics with correct UUIDs and properties
5. sendResponse() is called in every callback path where responseNeeded=true
6. notifyCharacteristicChanged uses API 33 compat check
7. Notification sends are serialized via Mutex (only one at a time, globally)
8. Per-device MTU stored as `mtu - 3` (usable payload, not ATT MTU)
</verification>

<success_criteria>
- rns-android compiles with the new BleGattServer and BLE permissions
- BleGattServer follows the Columba reference patterns adapted for this project
- All GATT-01 through GATT-07 requirements are addressed in the implementation
</success_criteria>

<output>
After completion, create `.planning/phases/19-gatt-server-advertising/19-01-SUMMARY.md`
</output>
