---
phase: 18-fragmentation-driver
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/BLEConstants.kt
  - rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/BLEDriver.kt
  - rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/DiscoveredPeer.kt

autonomous: true

must_haves:
  truths:
    - "BLEConstants defines all protocol constants (UUIDs, timeouts, sizes) with correct values matching Python reference"
    - "BLEDriver interface defines message-based contract with no Android imports"
    - "BLEPeerConnection interface defines fragment-level send/receive with SharedFlow"
    - "DiscoveredPeer data class holds identity, address, RSSI, and computes connection score"
    - "All code compiles on JVM without Android dependencies"
  artifacts:
    - path: "rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/BLEConstants.kt"
      provides: "Protocol constants (UUIDs, fragment header size, MTU, timeouts, keepalive)"
      contains: "SERVICE_UUID"
    - path: "rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/BLEDriver.kt"
      provides: "BLEDriver and BLEPeerConnection interfaces"
      exports: ["BLEDriver", "BLEPeerConnection"]
    - path: "rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/DiscoveredPeer.kt"
      provides: "Peer data class with scoring algorithm"
      exports: ["DiscoveredPeer"]
  key_links:
    - from: "BLEDriver.kt"
      to: "BLEConstants.kt"
      via: "imports DEFAULT_MTU and other constants"
      pattern: "BLEConstants"
    - from: "BLEDriver.kt"
      to: "DiscoveredPeer.kt"
      via: "discoveredPeers flow emits DiscoveredPeer"
      pattern: "SharedFlow<DiscoveredPeer>"
---

<objective>
Define the BLE protocol constants, driver abstraction interface, and peer discovery data model that all subsequent BLE phases build against.

Purpose: Establish the module boundary between pure-JVM protocol logic (rns-interfaces) and Android BLE implementation (rns-sample-app). This is the contract that Phase 19 (GATT Server), Phase 20 (GATT Client), and Phase 21 (Orchestration) depend on.

Output: Three Kotlin files in `rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/` -- BLEConstants.kt, BLEDriver.kt, DiscoveredPeer.kt
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/v3/SUMMARY.md

# Existing interface patterns to follow
@rns-interfaces/src/main/kotlin/network/reticulum/interfaces/Interface.kt
@rns-interfaces/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BLEConstants, BLEDriver interface, and DiscoveredPeer</name>
  <files>
    rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/BLEConstants.kt
    rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/BLEDriver.kt
    rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/DiscoveredPeer.kt
  </files>
  <action>
Create the `network.reticulum.interfaces.ble` package with three files:

**BLEConstants.kt** -- Protocol constants object. Values MUST match the Python reference exactly:
```kotlin
object BLEConstants {
    // GATT Service and Characteristic UUIDs
    val SERVICE_UUID: java.util.UUID = java.util.UUID.fromString("37145b00-442d-4a94-917f-8f42c5da28e3")
    val RX_CHAR_UUID: java.util.UUID = java.util.UUID.fromString("37145b00-442d-4a94-917f-8f42c5da28e5")
    val TX_CHAR_UUID: java.util.UUID = java.util.UUID.fromString("37145b00-442d-4a94-917f-8f42c5da28e4")
    val IDENTITY_CHAR_UUID: java.util.UUID = java.util.UUID.fromString("37145b00-442d-4a94-917f-8f42c5da28e6")

    // Fragment header
    const val FRAGMENT_HEADER_SIZE = 5
    const val FRAGMENT_TYPE_START: Byte = 0x01
    const val FRAGMENT_TYPE_CONTINUE: Byte = 0x02
    const val FRAGMENT_TYPE_END: Byte = 0x03

    // MTU
    const val DEFAULT_MTU = 185
    const val MIN_MTU = 20

    // Keepalive
    const val KEEPALIVE_BYTE: Byte = 0x00
    const val KEEPALIVE_INTERVAL_MS = 15_000L

    // Timeouts
    const val REASSEMBLY_TIMEOUT_MS = 30_000L
    const val IDENTITY_HANDSHAKE_TIMEOUT_MS = 30_000L

    // Identity
    const val IDENTITY_SIZE = 16
}
```

**BLEDriver.kt** -- Two interfaces defining the message-based driver contract. MUST NOT import any Android classes. Use `kotlinx.coroutines.flow.SharedFlow` for event streams. The driver is the abstraction boundary between protocol logic and platform BLE:

```kotlin
interface BLEDriver {
    // Lifecycle
    suspend fun startAdvertising()
    suspend fun stopAdvertising()
    suspend fun startScanning()
    suspend fun stopScanning()
    suspend fun connect(address: String): BLEPeerConnection
    suspend fun disconnect(address: String)
    fun shutdown()

    // Event flows
    val discoveredPeers: SharedFlow<DiscoveredPeer>
    val incomingConnections: SharedFlow<BLEPeerConnection>
    val connectionLost: SharedFlow<String>  // peer address

    // State
    val localAddress: String?
    val isRunning: Boolean
}

interface BLEPeerConnection {
    val address: String
    val mtu: Int
    val identity: ByteArray?

    suspend fun sendFragment(data: ByteArray)
    val receivedFragments: SharedFlow<ByteArray>

    suspend fun readIdentity(): ByteArray
    suspend fun writeIdentity(identity: ByteArray)

    fun close()
}
```

**DiscoveredPeer.kt** -- Data class for discovered BLE peers with scoring. Scoring formula: RSSI (60%) + connection history success rate (30%) + recency (10%). Include:
- `identity: ByteArray?` (null until handshake)
- `address: String` (BLE MAC)
- `rssi: Int`
- `lastSeen: Long` (System.currentTimeMillis)
- `connectionAttempts: Int` (default 0)
- `connectionSuccesses: Int` (default 0)
- `fun connectionScore(): Double` -- computes weighted score
  - RSSI component: normalize RSSI from [-100, -30] to [0.0, 1.0], clamp, weight 0.6
  - History component: successRate = successes / max(attempts, 1), weight 0.3
  - Recency component: age in seconds, decay exponentially with 60s half-life, weight 0.1
- Override `equals`/`hashCode` to use `address` only (peers are identified by address before identity is known)

IMPORTANT constraints:
- Package: `network.reticulum.interfaces.ble`
- No Android imports anywhere
- Use `java.util.UUID` not Android's ParcelUuid
- SharedFlow from `kotlinx.coroutines.flow`
  </action>
  <verify>
Run: `JAVA_HOME=~/android-studio/jbr ./gradlew -p ~/repos/public/reticulum-kt :rns-interfaces:compileKotlin`

Verify no Android imports: `grep -r "android\." rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/`
  </verify>
  <done>
All three files compile on JVM. BLEConstants has all protocol values. BLEDriver/BLEPeerConnection interfaces are message-based with SharedFlow events. DiscoveredPeer has scoring algorithm. Zero Android imports.
  </done>
</task>

</tasks>

<verification>
1. `JAVA_HOME=~/android-studio/jbr ./gradlew :rns-interfaces:compileKotlin` succeeds
2. `grep -rn "android\." rns-interfaces/src/main/kotlin/network/reticulum/interfaces/ble/` returns nothing
3. BLEConstants values match the Python reference (SERVICE_UUID, fragment types, header size, default MTU)
4. BLEDriver interface has no stream-based APIs (no InputStream/OutputStream)
5. DiscoveredPeer.connectionScore() returns values in [0.0, 1.0] range
</verification>

<success_criteria>
- BLEConstants.kt exists with all protocol constants matching Python reference values
- BLEDriver.kt defines BLEDriver and BLEPeerConnection interfaces with message-based API
- DiscoveredPeer.kt defines data class with RSSI/history/recency scoring
- All code compiles on JVM without Android dependencies
- Package is `network.reticulum.interfaces.ble`
</success_criteria>

<output>
After completion, create `.planning/phases/18-fragmentation-driver/18-01-SUMMARY.md`
</output>
