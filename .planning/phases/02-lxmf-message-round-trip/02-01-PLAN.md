---
phase: 02-lxmf-message-round-trip
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LXMFInteropTestBase.kt
  - lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/KotlinToPythonMessageTest.kt
autonomous: true

must_haves:
  truths:
    - "Kotlin-created LXMessage unpacks in Python with all base fields preserved"
    - "Message destination/source hashes match after round-trip"
    - "Timestamp survives round-trip intact"
    - "Title and content survive round-trip intact"
    - "Empty message round-trips correctly"
    - "Unicode content round-trips correctly"
  artifacts:
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LXMFInteropTestBase.kt"
      provides: "Shared test fixtures for LXMF interop testing"
      contains: "class LXMFInteropTestBase"
    - path: "lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/KotlinToPythonMessageTest.kt"
      provides: "Kotlin-to-Python round-trip tests"
      contains: "class KotlinToPythonMessageTest"
  key_links:
    - from: "KotlinToPythonMessageTest.kt"
      to: "python-bridge/bridge_server.py"
      via: "PythonBridge lxmf_unpack command"
      pattern: "python.*lxmf_unpack"
    - from: "LXMFInteropTestBase.kt"
      to: "InteropTestBase"
      via: "class inheritance"
      pattern: "InteropTestBase"
---

<objective>
Verify Kotlin-created LXMessages unpack correctly in Python via the bridge.

Purpose: Proves LXMF-01 requirement - Kotlin-packed messages are byte-compatible with Python. This is half of the round-trip verification needed for interoperability.

Output: Shared LXMF test base class and KotlinToPythonMessageTest test suite.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lxmf-message-round-trip/02-CONTEXT.md
@.planning/phases/02-lxmf-message-round-trip/02-RESEARCH.md
@.planning/phases/01-python-bridge-extension/01-01-SUMMARY.md

# Key source files
@rns-test/src/test/kotlin/network/reticulum/interop/InteropTestBase.kt
@lxmf-core/src/main/kotlin/network/reticulum/lxmf/LXMessage.kt
@lxmf-core/src/test/kotlin/network/reticulum/lxmf/LXMessageTest.kt
@python-bridge/bridge_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LXMFInteropTestBase shared fixtures</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/LXMFInteropTestBase.kt</files>
  <action>
Create LXMFInteropTestBase.kt that extends InteropTestBase and provides:

1. Shared test identities setup in @BeforeAll:
   - testSourceIdentity: Identity.create()
   - testDestIdentity: Identity.create()
   - sourceDestination: Destination.create() with lxmf/delivery app name
   - destDestination: Destination.create() with lxmf/delivery app name
   - Remember source identity via Identity.remember() for signature validation

2. Helper method to create test messages:
   ```kotlin
   protected fun createTestMessage(
       content: String,
       title: String = "",
       fields: MutableMap<Int, Any> = mutableMapOf()
   ): LXMessage
   ```

3. Helper method to verify message in Python:
   ```kotlin
   protected fun verifyInPython(lxmfBytes: ByteArray): JsonObject
   ```
   - Calls python("lxmf_unpack", "lxmf_bytes" to lxmfBytes.toHex())
   - Logs timing information per CONTEXT.md requirements
   - Returns the JsonObject result

4. Helper method for soft assertion comparison:
   ```kotlin
   protected fun assertMessageMatchesPython(
       kotlinMessage: LXMessage,
       pythonResult: JsonObject,
       message: String = ""
   )
   ```
   - Uses Kotest assertSoftly to collect all failures
   - Compares: destinationHash, sourceHash, timestamp, title, content, messageHash
   - Converts JSON string keys to appropriate types

Use @TestInstance(TestInstance.Lifecycle.PER_CLASS) annotation.
Import io.kotest.assertions.assertSoftly and io.kotest.matchers.shouldBe.
  </action>
  <verify>
File compiles: `cd ~/repos/public/reticulum-kt && ./gradlew :lxmf-core:compileTestKotlin --quiet`
  </verify>
  <done>
LXMFInteropTestBase.kt exists with shared fixtures for LXMF interop testing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KotlinToPythonMessageTest</name>
  <files>lxmf-core/src/test/kotlin/network/reticulum/lxmf/interop/KotlinToPythonMessageTest.kt</files>
  <action>
Create KotlinToPythonMessageTest.kt that extends LXMFInteropTestBase:

1. Test: `kotlin message unpacks in Python with all fields preserved`
   - Create message with title="Test Title", content="Hello, World!"
   - Pack message
   - Verify in Python via bridge
   - Use assertMessageMatchesPython helper
   - Also verify packed bytes equal (byte-level truth)

2. Test: `empty message round-trips correctly`
   - Create message with title="", content=""
   - Pack and verify in Python
   - Verify empty strings preserved

3. Test: `unicode content round-trips correctly`
   - Create message with unicode content: "Hello, World! / Hej verden! / Hola mundo! / Ciao mondo!"
   - Include emoji in content (per CONTEXT.md discretion on Unicode coverage)
   - Pack and verify UTF-8 bytes match in Python

4. Test: `message with fields round-trips correctly`
   - Create message with FIELD_RENDERER set
   - Pack and verify field preserved in Python
   - Note: JSON returns field keys as strings, convert appropriately

5. Test: `timestamp precision preserved`
   - Create message with current timestamp (System.currentTimeMillis() / 1000.0)
   - Pack and verify timestamp matches in Python
   - Use float64 comparison (both use IEEE 754)

Each test should:
- Log timing for pack/unpack operations
- Use assertSoftly for field-by-field comparison
- Verify message hash matches between implementations

Use @Test annotation from JUnit 5.
  </action>
  <verify>
Tests pass: `cd ~/repos/public/reticulum-kt && PYTHON_RNS_PATH=~/repos/Reticulum PYTHON_LXMF_PATH=~/repos/LXMF ./gradlew :lxmf-core:test --tests "network.reticulum.lxmf.interop.KotlinToPythonMessageTest" --info`
  </verify>
  <done>
All KotlinToPythonMessageTest tests pass, proving Kotlin messages unpack correctly in Python.
  </done>
</task>

</tasks>

<verification>
1. Shared test base compiles without errors
2. All KotlinToPythonMessageTest tests pass
3. Tests use soft assertions and log timing
4. Message hashes match between implementations
5. All base fields (timestamp, title, content, hashes) survive round-trip
</verification>

<success_criteria>
- [ ] LXMFInteropTestBase.kt provides shared fixtures
- [ ] KotlinToPythonMessageTest.kt has 5 test cases
- [ ] All tests pass with Python bridge
- [ ] Timing logged for pack/unpack operations
- [ ] Message hashes verified matching
</success_criteria>

<output>
After completion, create `.planning/phases/02-lxmf-message-round-trip/02-01-SUMMARY.md`
</output>
